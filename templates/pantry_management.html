{% extends "base.html" %}
{% import "components/typography.html" as type %}

{% block title %}Pantry Management - The Lazy Chef{% endblock %}

{% block content %}
<div class="bg-white min-h-screen pb-24">
    <!-- Header -->
    <div class="bg-slate-50 border-b border-slate-200">
        <div class="max-w-screen-2xl mx-auto px-4 py-8 text-center">
            {{ type.page_header('Pantry Management', 'Manage your staple ingredients and preferences.') }}
            <p class="mt-2 text-sm text-slate-500">Flag ingredients as "Basic" to tell the AI what you always have in
                stock.</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-screen-xl mx-auto px-4 py-8">

        <div
            class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden flex flex-col relative h-[800px]">
            <!-- Facet Menu Container (Fixed/Absolute Overlay) -->
            <div id="facetMenu"
                class="hidden absolute z-50 bg-white border border-slate-200 shadow-xl rounded-lg w-64 max-h-80 flex flex-col">
                <div class="p-2 border-b border-slate-100 bg-slate-50 flex justify-between items-center rounded-t-lg">
                    <span class="text-xs font-bold text-slate-700" id="facetMenuTitle">Filter</span>
                    <button onclick="closeFacetMenu()" class="text-slate-400 hover:text-slate-600">&times;</button>
                </div>
                <div class="p-2 border-b border-slate-100 flex gap-2">
                    <button onclick="facetSelectAll(true)"
                        class="text-[10px] text-blue-600 font-medium hover:underline">Select All</button>
                    <button onclick="facetSelectAll(false)"
                        class="text-[10px] text-blue-600 font-medium hover:underline">Deselect All</button>
                </div>
                <div class="overflow-y-auto p-2 flex-grow space-y-1" id="facetList">
                    <!-- Checkboxes go here -->
                </div>
            </div>

            <div class="overflow-auto flex-grow">
                <table class="w-full text-left border-collapse" id="pantryTable">
                    <thead class="bg-slate-50 border-b border-slate-200 sticky top-0 z-20 shadow-sm">
                        <!-- Row 1: Sort Headers -->
                        <tr class="text-xs uppercase text-slate-500 font-semibold tracking-wider">
                            <th class="p-4 w-1/6 cursor-pointer hover:bg-slate-100 group select-none sticky top-0 bg-slate-50 z-10"
                                onclick="sortTable('category')">
                                <div class="flex items-center gap-1">
                                    Category
                                    <span
                                        class="sort-icon text-slate-300 group-hover:text-slate-500 text-[10px]">▲▼</span>
                                </div>
                            </th>
                            <th class="p-4 w-1/6 cursor-pointer hover:bg-slate-100 group select-none sticky top-0 bg-slate-50 z-10"
                                onclick="sortTable('subcategory')">
                                <div class="flex items-center gap-1">
                                    Sub-Cat
                                    <span
                                        class="sort-icon text-slate-300 group-hover:text-slate-500 text-[10px]">▲▼</span>
                                </div>
                            </th>
                            <th class="p-4 w-1/4 cursor-pointer hover:bg-slate-100 group select-none sticky top-0 bg-slate-50 z-10"
                                onclick="sortTable('name')">
                                <div class="flex items-center gap-1">
                                    Ingredient Name
                                    <span
                                        class="sort-icon text-slate-300 group-hover:text-slate-500 text-[10px]">▲▼</span>
                                </div>
                            </th>
                            <th class="p-4 w-20 text-center sticky top-0 bg-slate-50 z-10">Actions</th>
                            <th class="p-4 w-16 cursor-pointer hover:bg-slate-100 group select-none sticky top-0 bg-slate-50 z-10"
                                onclick="sortTable('unit')">
                                Unit
                            </th>
                            <th class="p-4 w-12 text-center cursor-pointer hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                title="Calories (kcal)" onclick="sortTable('cal', true)">Cal</th>
                            <th class="p-4 w-12 text-center clickable hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                title="Kilojoules (kJ)">kJ</th>
                            <th class="p-4 w-12 text-center cursor-pointer hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                title="Protein (g)" onclick="sortTable('prot', true)">Prot</th>
                            <th class="p-4 w-12 text-center cursor-pointer hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                title="Carbohydrates (g)" onclick="sortTable('carb', true)">Carb</th>
                            <th class="p-4 w-12 text-center cursor-pointer hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                title="Fat (g)" onclick="sortTable('fat', true)">Fat</th>
                            <th class="p-4 w-12 text-center clickable hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                title="Sugar (g)">Sug</th>
                            <th class="p-4 w-12 text-center clickable hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                title="Fiber (g)">Fib</th>
                            <th class="p-4 w-12 text-center clickable hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                title="Sodium (mg)">Sod</th>
                            <th class="p-4 w-24 text-center cursor-pointer hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                onclick="sortTable('date')">Date Added</th>
                            <th class="p-4 w-24 text-center cursor-pointer hover:bg-slate-100 sticky top-0 bg-slate-50 z-10"
                                onclick="sortTable('basic')">Basic?</th>
                        </tr>
                        <!-- Row 2: Filters -->
                        <tr class="bg-slate-50 border-b border-slate-200">
                            <th class="p-2 sticky top-[50px] bg-slate-50 z-10">
                                <div class="flex items-center gap-1">
                                    <input type="text" placeholder="Filter..."
                                        class="w-full text-xs border border-slate-300 rounded px-2 py-1 focus:ring-1 focus:ring-orange-500 focus:outline-none font-normal"
                                        oninput="updateTextFilter('category', this.value)">
                                    <button
                                        class="p-1 hover:bg-white border border-transparent hover:border-slate-300 rounded text-slate-400 hover:text-orange-600 transition-all"
                                        onclick="openFacetMenu(this, 'category')">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </th>
                            <th class="p-2 sticky top-[50px] bg-slate-50 z-10">
                                <div class="flex items-center gap-1">
                                    <input type="text" placeholder="Filter..."
                                        class="w-full text-xs border border-slate-300 rounded px-2 py-1 focus:ring-1 focus:ring-orange-500 focus:outline-none font-normal"
                                        oninput="updateTextFilter('subcategory', this.value)">
                                    <button
                                        class="p-1 hover:bg-white border border-transparent hover:border-slate-300 rounded text-slate-400 hover:text-orange-600 transition-all"
                                        onclick="openFacetMenu(this, 'subcategory')">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </th>
                            <th class="p-2 sticky top-[50px] bg-slate-50 z-10">
                                <input type="text" placeholder="Filter name..."
                                    class="w-full text-xs border border-slate-300 rounded px-2 py-1 focus:ring-1 focus:ring-orange-500 focus:outline-none font-normal"
                                    oninput="updateTextFilter('name', this.value)">
                            </th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <!-- Spacers for other columns -->
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                            <th class="sticky top-[50px] bg-slate-50 z-10"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="ingredientTableBody">
                        {% for ing in ingredients %}
                        <tr class="transition-colors group/row hover:bg-orange-50/50 ingredient-row"
                            data-id="{{ ing.id }}" data-category="{{ ing.main_category or 'Other' }}"
                            data-subcategory="{{ ing.sub_category or '-' }}" data-name="{{ ing.name }}"
                            data-unit="{{ ing.default_unit }}" data-cal="{{ ing.calories_per_100g or 0 }}"
                            data-prot="{{ ing.protein_per_100g or 0 }}" data-carb="{{ ing.carbs_per_100g or 0 }}"
                            data-fat="{{ ing.fat_per_100g or 0 }}" data-date="{{ ing.created_at or '' }}"
                            data-basic="{{ 'yes' if ing.is_basic_ingredient else 'no' }}">

                            <!-- A: Main Category -->
                            <td class="p-4 text-xs font-semibold text-slate-600 align-middle">{{ ing.main_category or
                                'Other' }}</td>

                            <!-- B: Sub Category -->
                            <td class="p-4 text-xs text-slate-500 align-middle">{{ ing.sub_category or '-' }}</td>

                            <!-- C: Name & ID -->
                            <td class="p-4 font-medium align-middle">
                                <div class="flex items-center gap-3">
                                    <div class="relative group/img">
                                        {% if ing.image_url %}
                                        {% if ing.image_url.startswith('http') %}
                                        <img src="{{ ing.image_url }}" alt="{{ ing.name }}" id="img-row-{{ ing.id }}"
                                            class="w-10 h-10 rounded-md object-cover bg-slate-100 shadow-sm border border-slate-100"
                                            loading="lazy">
                                        {% else %}
                                        <img src="{{ url_for('static', filename=ing.image_url) }}" alt="{{ ing.name }}"
                                            id="img-row-{{ ing.id }}"
                                            class="w-10 h-10 rounded-md object-cover bg-slate-100 shadow-sm border border-slate-100"
                                            loading="lazy">
                                        {% endif %}
                                        {% else %}
                                        <div id="img-row-{{ ing.id }}"
                                            class="w-10 h-10 rounded-md bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-300">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                                </path>
                                            </svg>
                                        </div>
                                        {% endif %}

                                        <!-- Hover Actions -->
                                        <div
                                            class="absolute -bottom-2 -right-2 flex gap-1 opacity-0 group-hover/row:opacity-100 transition-opacity z-10">
                                            <button onclick="openRegenModal('{{ ing.id }}')"
                                                class="bg-white text-orange-600 rounded-full p-1 shadow border border-slate-200 hover:bg-orange-50"
                                                title="Regenerate Image"><svg class="w-3 h-3" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                                </svg></button>
                                        </div>
                                    </div>
                                </div>
            </div>
            </td>

            <!-- Actions -->
            <td class="p-4 text-center align-middle whitespace-nowrap bg-slate-50/20">
                <div class="flex items-center justify-center gap-2">
                    <a href="/new-ingredient?edit_id={{ ing.id }}"
                        class="text-slate-400 hover:text-indigo-600 transition-colors p-1 rounded hover:bg-slate-100"
                        title="Edit Ingredient">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                            </path>
                        </svg>
                    </a>
                    <button onclick="deleteIngredient('{{ ing.id }}', this.dataset.name)" data-name="{{ ing.name }}"
                        class="text-slate-400 hover:text-red-600 transition-colors p-1 rounded hover:bg-red-50"
                        title="Delete Ingredient">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>
                </div>
            </td>

            <td class="p-4 text-xs text-slate-500 align-middle">{{ ing.default_unit }}</td>

            <!-- Nutrition Data -->
            <td class="p-4 text-xs text-slate-600 text-center tabular-nums font-mono bg-slate-50/50 align-middle">
                {{ ing.calories_per_100g|int if ing.calories_per_100g is not none else '-' }}</td>
            <td class="p-4 text-xs text-slate-400 text-center tabular-nums font-mono align-middle">{{
                ing.kj_per_100g|int if ing.kj_per_100g is not none else '-' }}</td>
            <td class="p-4 text-xs text-slate-600 text-center tabular-nums font-mono bg-slate-50/50 align-middle">
                {{ ing.protein_per_100g|round(1) if ing.protein_per_100g is not none else '-' }}</td>
            <td class="p-4 text-xs text-slate-600 text-center tabular-nums font-mono align-middle">{{
                ing.carbs_per_100g|round(1) if ing.carbs_per_100g is not none else '-' }}</td>
            <td class="p-4 text-xs text-slate-600 text-center tabular-nums font-mono bg-slate-50/50 align-middle">
                {{ ing.fat_per_100g|round(1) if ing.fat_per_100g is not none else '-' }}</td>
            <td class="p-4 text-xs text-slate-400 text-center tabular-nums font-mono align-middle">{{
                ing.sugar_per_100g|round(1) if ing.sugar_per_100g is not none else '-' }}</td>
            <td class="p-4 text-xs text-slate-400 text-center tabular-nums font-mono bg-slate-50/50 align-middle">
                {{ ing.fiber_per_100g|round(1) if ing.fiber_per_100g is not none else '-' }}</td>
            <td class="p-4 text-xs text-slate-400 text-center tabular-nums font-mono align-middle">{{
                ing.sodium_mg_per_100g|int if ing.sodium_mg_per_100g is not none else '-' }}</td>

            <!-- Date Added -->
            <td class="p-4 text-xs text-slate-500 text-center align-middle whitespace-nowrap">
                {{ ing.created_at[:10] if ing.created_at else '-' }}
            </td>

            <!-- Basic Toggle -->
            <td class="p-4 text-center cursor-pointer select-none align-middle"
                onclick="toggleBasic('{{ ing.id }}', this)">
                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm transition-all duration-200 badge-status
                                    {% if ing.is_basic_ingredient %}
                                        bg-green-100 text-green-700 font-bold
                                    {% else %}
                                        bg-slate-100 text-slate-400 font-normal hover:bg-slate-200
                                    {% endif %}" id="status-{{ ing.id }}">
                    {% if ing.is_basic_ingredient %}Yes{% else %}No{% endif %}
                </span>
            </td>


            </tr>
            {% endfor %}
            </tbody>
            </table>
        </div>
    </div>

</div>

<!-- REGENERATE IMAGE MODAL -->
<div id="regenModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">

            <div
                class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div
                            class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-orange-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-base font-semibold leading-6 text-slate-900" id="modalTitle">Regenerate
                                Image</h3>
                            <div class="mt-2">
                                <p class="text-xs text-slate-500 mb-2">Review the AI prompt and generate new 1:1
                                    ingredient images.</p>
                                <textarea id="modalPrompt" rows="3"
                                    class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-xs sm:leading-6"></textarea>
                                <div id="modalGrid" class="mt-4 grid grid-cols-2 gap-2">
                                    <div
                                        class="col-span-2 aspect-[1/1] bg-slate-50 rounded border border-dashed border-slate-300 flex items-center justify-center">
                                        <span class="text-xs text-slate-400">Images will appear here</span>
                                    </div>
                                </div>
                                <input type="hidden" id="modalIngId">
                                <input type="hidden" id="modalTempFilename">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" id="btnSaveModal" onclick="saveRegenImage()" disabled
                        class="inline-flex w-full justify-center rounded-md bg-slate-900 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-700 sm:ml-3 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed">
                        Save Selection
                    </button>
                    <button type="button" id="btnGenModal" onclick="generateRegenImage()"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-orange-600 px-3 py-2 text-sm font-semibold text-white shadow-sm ring-1 ring-inset ring-orange-300 hover:bg-orange-500 sm:mt-0 sm:ml-3 sm:w-auto">
                        Generate
                    </button>
                    <button type="button" onclick="closeModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- JSON VIEWER MODAL -->
<div id="jsonModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeJsonModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div
                class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:w-full sm:max-w-2xl">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-base font-semibold leading-6 text-slate-900" id="jsonModalTitle">Ingredient
                            Data</h3>
                        <button onclick="closeJsonModal()" class="text-slate-400 hover:text-slate-500">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="bg-slate-900 rounded-lg p-4 overflow-auto max-h-[600px]">
                        <pre id="jsonContent" class="text-xs text-green-400 font-mono"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- State ---
    let state = {
        filters: {
            text: {
                category: '',
                subcategory: '',
                name: ''
            },
            facets: {
                category: new Set(),
                subcategory: new Set()
            }
        },
        sort: {
            column: null,
            asc: true
        }
    };

    // Constraint Map
    const SUB_CATEGORY_MAP = {{ sub_categories_map | tojson }};

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Build initial facet options from data
        buildFacetOptions('category');
        buildFacetOptions('subcategory');
    });

    // --- Sorting ---
    function sortTable(column, isNumeric = false) {
        const tbody = document.getElementById('ingredientTableBody');
        let rows = Array.from(tbody.querySelectorAll('tr'));

        // Toggle direction
        if (state.sort.column === column) {
            state.sort.asc = !state.sort.asc;
        } else {
            state.sort.column = column;
            state.sort.asc = true; // Default to asc
        }

        // Update Headers UI
        updateSortIcons(column, state.sort.asc);

        // Sort
        rows.sort((a, b) => {
            let valA = a.dataset[column];
            let valB = b.dataset[column];

            if (isNumeric) {
                valA = parseFloat(valA) || 0;
                valB = parseFloat(valB) || 0;
            } else {
                valA = (valA || '').toLowerCase();
                valB = (valB || '').toLowerCase();
            }

            if (valA < valB) return state.sort.asc ? -1 : 1;
            if (valA > valB) return state.sort.asc ? 1 : -1;
            return 0;
        });

        // Re-append
        rows.forEach(row => tbody.appendChild(row));
    }

    function updateSortIcons(activeCol, asc) {
        // Reset all icons
        document.querySelectorAll('th .sort-icon').forEach(icon => {
            icon.textContent = '▲▼';
            icon.classList.remove('text-orange-600', 'text-slate-700');
            icon.classList.add('text-slate-300');
        });

        // Find active header
        const activeTh = document.querySelector(`th[onclick*="'${activeCol}'"]`);
        if (activeTh) {
            const icon = activeTh.querySelector('.sort-icon');
            if (icon) {
                icon.textContent = asc ? '▲' : '▼';
                icon.classList.remove('text-slate-300');
                icon.classList.add('text-orange-600');
            }
        }
    }

    // --- Filtering ---

    function updateTextFilter(col, value) {
        state.filters.text[col] = value.toLowerCase();
        applyFilters();
    }

    function applyFilters() {
        const rows = document.querySelectorAll('#ingredientTableBody tr');

        rows.forEach(row => {
            const d = row.dataset;
            let visible = true;

            if (state.filters.text.category && !d.category.toLowerCase().includes(state.filters.text.category)) visible = false;
            if (state.filters.text.subcategory && !d.subcategory.toLowerCase().includes(state.filters.text.subcategory)) visible = false;
            if (state.filters.text.name && !d.name.toLowerCase().includes(state.filters.text.name)) visible = false;

            if (visible && state.filters.facets.category.size > 0) {
                if (!state.filters.facets.category.has(d.category.toLowerCase())) visible = false;
            }

            if (visible && state.filters.facets.subcategory.size > 0) {
                const val = d.subcategory.toLowerCase();
                if (!state.filters.facets.subcategory.has(val)) visible = false;
            }

            row.style.display = visible ? '' : 'none';
        });
    }

    // --- Faceted Menu Logic ---
    let currentFacetCol = null;

    function buildFacetOptions(col) {
        // Scan all rows to get unique values
        const rows = document.querySelectorAll('#ingredientTableBody tr');
        const values = new Set();
        rows.forEach(r => {
            const val = r.dataset[col];
            if (val) values.add(val.toLowerCase()); // Store normalized
        });

        // Dependency: If filtering Sub-Category, restrict to selected Categories
        if (col === 'subcategory' && state.filters.facets.category.size > 0) {
            const allowedSubcats = new Set();
            state.filters.facets.category.forEach(cat => {
                // cat is lowercase
                const subList = SUB_CATEGORY_MAP[cat];
                if (subList) {
                    subList.forEach(s => allowedSubcats.add(s.toLowerCase()));
                }
            });

            // Only keep values that are in the allowed list
            const filteredValues = new Set();
            values.forEach(v => {
                if (allowedSubcats.has(v)) filteredValues.add(v);
            });
            return Array.from(filteredValues).sort();
        }

        // Return sorted list
        return Array.from(values).sort();
    }

    function openFacetMenu(btn, col) {
        const menu = document.getElementById('facetMenu');
        const list = document.getElementById('facetList');
        const title = document.getElementById('facetMenuTitle');

        currentFacetCol = col;
        title.textContent = `Filter ${col}`;
        list.innerHTML = ''; // Clear

        // Get unique values from ALL rows (not just visible ones, or else you can't broaden filter)
        const uniqueValues = buildFacetOptions(col);

        uniqueValues.forEach(val => {
            const label = document.createElement('label');
            label.className = "flex items-center gap-2 px-2 py-1 hover:bg-slate-50 cursor-pointer text-xs";

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = val;
            checkbox.className = "rounded border-slate-300 text-orange-600 focus:ring-orange-500";

            // Checked state?
            if (state.filters.facets[col].size === 0 || state.filters.facets[col].has(val)) {
                // If empty, we treat as "All Selected" visually? 
                // No, standard pattern: Empty = All. Checked = Included.
                // If I have 0 checked, I show all. 
                // So if 0 checked, these should be unchecked.
                // Wait, if I check one, the rest disappear. 
                checkbox.checked = state.filters.facets[col].has(val);
            } else {
                checkbox.checked = state.filters.facets[col].has(val);
            }

            checkbox.onchange = (e) => {
                const v = e.target.value;
                const set = state.filters.facets[col];
                if (e.target.checked) {
                    set.add(v);
                } else {
                    set.delete(v);
                }
                applyFilters();
            };

            const span = document.createElement('span');
            span.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if (val === '-' || val === '') span.textContent = '(None)';

            label.appendChild(checkbox);
            label.appendChild(span);
            list.appendChild(label);
        });

        // Position Menu
        const rect = btn.getBoundingClientRect();
        // Adjust for scroll offset if needed, but 'fixed' is easier for overlays
        // But the parent container has overflow-hidden? No, I put the menu relative in the plan? 
        // I put it absolute in the container.

        // Find position relative to the container
        const container = btn.closest('.relative'); // The card container
        const containerRect = container.getBoundingClientRect();

        // relative top/left. 
        // btn.top - container.top + btn.height
        menu.style.top = (rect.bottom - containerRect.top + container.scrollTop) + 'px';
        menu.style.left = (rect.left - containerRect.left) + 'px';

        menu.classList.remove('hidden');
    }

    function closeFacetMenu() {
        document.getElementById('facetMenu').classList.add('hidden');
    }

    function facetSelectAll(select) {
        if (!currentFacetCol) return;
        const set = state.filters.facets[currentFacetCol];
        const rows = document.querySelectorAll('#ingredientTableBody tr');

        if (select) {
            // Select Only Visible? Or All? 
            // Usually "Select All" determines the filter state.
            // If I select "All", I shouldn't populate the Set with EVERYTHING. I should CLEAR the set (Empty = All).
            // But visually I want checks. 
            // Let's implement: Select All -> Add ALL values to Set.
            // Deselect All -> Clear Set.
            const uniqueValues = buildFacetOptions(currentFacetCol);
            uniqueValues.forEach(v => set.add(v));
        } else {
            set.clear();
        }

        // Update checkboxes in UI
        const checkboxes = document.querySelectorAll('#facetList input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = select); // If select=false, unchecked.

        // If I deselect all, set is empty -> All Visible.
        // If I select all, set is full -> All Visible.
        // There is a nuance: If I manually uncheck one item from "All", I want to exclude it.
        // My filter logic: "If size > 0, Must be in set". 
        // So if I select all, size > 0, match logic works (all match).
        // If I deselect all, size == 0, match logic skipped (all match).
        // Works out the same.

        applyFilters();
    }


    // --- Toggle Basic Logic (Existing) ---
    async function toggleBasic(id, cell) {
        const badge = document.getElementById(`status-${id}`);
        // Optimistic
        const isCurrentlyBasic = badge.innerText.includes('Yes');
        const newBasic = !isCurrentlyBasic;

        const row = badge.closest('tr');
        const nameText = row.querySelector('.name-text');

        // UI Update
        if (newBasic) {
            badge.innerText = 'Yes';
            badge.classList.remove('bg-slate-100', 'text-slate-400', 'font-normal');
            badge.classList.add('bg-green-100', 'text-green-700', 'font-bold');
            nameText.classList.add('text-slate-900', 'font-bold');
            nameText.classList.remove('text-slate-500', 'font-normal');
            row.dataset.basic = 'yes';
        } else {
            badge.innerText = 'No';
            badge.classList.add('bg-slate-100', 'text-slate-400', 'font-normal');
            badge.classList.remove('bg-green-100', 'text-green-700', 'font-bold');
            nameText.classList.remove('text-slate-900', 'font-bold');
            nameText.classList.add('text-slate-500', 'font-normal');
            row.dataset.basic = 'no';
        }

        try {
            const response = await fetch(`/api/ingredient/${id}/toggle_basic`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });
            if (!response.ok) throw new Error("Failed");
        } catch (e) {
            console.error(e);
            // Revert (simplified)
            alert("Error updating status");
        }
    }

    // --- Modal Logic (Existing) ---
    async function openRegenModal(id) {
        const modal = document.getElementById('regenModal');
        const title = document.getElementById('modalTitle');
        const promptInput = document.getElementById('modalPrompt');
        const ingIdInput = document.getElementById('modalIngId');

        modal.classList.remove('hidden');
        promptInput.value = 'Loading...';

        try {
            const res = await fetch(`/api/ingredient/${id}`);
            const data = await res.json();
            if (data.success) {
                title.innerText = `Regenerate: ${data.name}`;
                promptInput.value = data.image_prompt;
                ingIdInput.value = data.id;
            }
        } catch (e) { console.error(e); }
    }

    function closeModal() { document.getElementById('regenModal').classList.add('hidden'); }

    let MODAL_IMAGES = [];
    async function generateRegenImage() {
        // ... (Same as before)
        const prompt = document.getElementById('modalPrompt').value;
        const btn = document.getElementById('btnGenModal');
        const grid = document.getElementById('modalGrid');

        btn.disabled = true;
        btn.innerText = "Generating...";

        grid.innerHTML = `
            <div class="col-span-2 aspect-[1/1] bg-slate-50 flex items-center justify-center">
                <div class="animate-spin h-6 w-6 border-2 border-orange-600 border-t-transparent rounded-full"></div>
            </div>`;

        try {
            const response = await fetch('/api/generate-ingredient-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });
            const res = await response.json();

            if (res.success) {
                MODAL_IMAGES = res.images;
                renderModalGrid(res.images);
            } else {
                grid.innerHTML = `<div class="col-span-2 text-red-500 text-xs p-2">Error: ${res.error}</div>`;
            }
        } catch (e) {
            console.error(e);
            grid.innerHTML = `<div class="col-span-2 text-red-500 text-xs p-2">Failed to generate.</div>`;
        } finally {
            btn.disabled = false;
            btn.innerText = "Generate";
        }
    }

    function renderModalGrid(images) {
        const grid = document.getElementById('modalGrid');
        grid.innerHTML = '';
        images.forEach((img, idx) => {
            const div = document.createElement('div');
            div.className = "relative aspect-square rounded overflow-hidden cursor-pointer border-2 border-transparent hover:border-orange-500";
            div.onclick = () => selectModalImage(idx);
            div.id = `modal-img-${idx}`;
            div.innerHTML = `<img src="${img.url}" class="w-full h-full object-cover">`;
            grid.appendChild(div);
        });
    }

    function selectModalImage(index) {
        const imgData = MODAL_IMAGES[index];
        document.getElementById('modalTempFilename').value = imgData.filename;
        document.getElementById('btnSaveModal').disabled = false;
        MODAL_IMAGES.forEach((_, idx) => {
            const el = document.getElementById(`modal-img-${idx}`);
            if (idx === index) el.classList.add('border-orange-500', 'ring-2');
            else el.classList.remove('border-orange-500', 'ring-2');
        });
    }

    async function saveRegenImage() {
        const id = document.getElementById('modalIngId').value;
        const tempFile = document.getElementById('modalTempFilename').value;
        const prompt = document.getElementById('modalPrompt').value;

        try {
            await fetch('/api/update-ingredient-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, temp_filename: tempFile, image_prompt: prompt })
            });
            window.location.reload();
        } catch (e) { alert("Error saving"); }
    }

    async function deleteIngredient(id, name, force = false) {
        if (!force && !confirm(`Delete ${name}?`)) return;

        const url = force ? `/api/ingredient/${id}?force=true` : `/api/ingredient/${id}`;

        try {
            const response = await fetch(url, { method: 'DELETE' });
            const data = await response.json();

            if (response.ok && data.success) {
                window.location.reload();
            } else if (data.requires_confirmation) {
                // Show the specific recipes and ask again
                if (confirm(data.message)) {
                    deleteIngredient(id, name, true);
                }
            } else {
                alert(`Error: ${data.error || "Failed to delete"}`);
            }
        } catch (e) {
            console.error(e);
            alert("Error deleting: " + e);
        }
    }

    // --- JSON Viewer Logic ---
    async function openJsonModal(id) {
        const modal = document.getElementById('jsonModal');
        const content = document.getElementById('jsonContent');
        const title = document.getElementById('jsonModalTitle');

        modal.classList.remove('hidden');
        content.innerText = 'Loading...';

        try {
            const res = await fetch(`/api/ingredient/${id}`);
            const data = await res.json();

            if (data.success) {
                title.innerText = `JSON Data: ${data.name}`;
                // Clean up the object to show relevant fields
                const displayData = { ...data };
                delete displayData.success;

                content.innerText = JSON.stringify(displayData, null, 2);
            } else {
                content.innerText = 'Error loading data: ' + data.error;
            }
        } catch (e) {
            content.innerText = 'Network Error: ' + e;
        }
    }

    function closeJsonModal() {
        document.getElementById('jsonModal').classList.add('hidden');
    }
</script>
{% endblock %}