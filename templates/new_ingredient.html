{% extends "base.html" %}

{% block content %}
<div class="relative overflow-hidden bg-slate-900 py-12">
    <!-- Abstract Background -->
    <div
        class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1606787366850-de6330128bfc?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80')] bg-cover bg-center opacity-10 mix-blend-overlay">
    </div>
    <div class="absolute inset-0 bg-gradient-to-b from-slate-900/50 via-slate-900/80 to-slate-900"></div>

    <div class="relative mx-auto max-w-3xl px-6 lg:px-8 text-center">
        <h1 class="font-serif text-3xl font-bold tracking-tight text-white mb-4">
            New Ingredient
        </h1>
        <p class="text-slate-400 text-sm">
            Expand your digital pantry with AI-assisted data entry.
        </p>
    </div>
</div>

<div class="bg-slate-50 py-12 min-h-screen">
    <div class="mx-auto max-w-5xl px-6 lg:px-8">

        <!-- STEP 1: Search / Prompt -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8 max-w-3xl mx-auto">
            <label class="block text-sm font-medium text-slate-700 mb-2">What do you want to add?</label>
            <div class="relative flex gap-2">
                <input type="text" id="userInput"
                    class="block w-full rounded-md border-slate-300 py-3 pl-4 pr-12 text-slate-900 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                    placeholder="e.g. 'Organic Gala Apples' or 'Sourdough Bread'"
                    onkeydown="if(event.key === 'Enter') checkDuplicates()">
                <button type="button" onclick="checkDuplicates()" id="btnSearch"
                    class="rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-700 transition-colors">
                    Check
                </button>
            </div>
            <p class="mt-2 text-xs text-slate-500">We'll check for duplicates first.</p>
        </div>

        <!-- STEP 2: Results & Actions -->
        <div id="resultsSection" class="hidden space-y-6 max-w-3xl mx-auto">

            <!-- Existing Matches -->
            <div id="duplicatesCard" class="bg-orange-50 rounded-xl border border-orange-100 p-6 hidden">
                <div class="flex items-start gap-3">
                    <div class="text-orange-600 mt-1">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                        </svg>
                    </div>
                    <div class="w-full">
                        <h3 class="text-sm font-semibold text-orange-900">Similar items found</h3>
                        <p class="text-xs text-orange-700 mt-1">Did you mean one of these?</p>
                        <div id="resultsList" class="mt-3 divide-y divide-orange-200/50">
                            <!-- JS Populated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create New Actions -->
            <div id="createNewAction" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 text-center">
                <div id="noResultsMsg" class="hidden mb-4">
                    <div
                        class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-green-100 text-green-600 mb-2">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-slate-900">No duplicates found!</p>
                </div>

                <h3 class="text-lg font-serif font-bold text-slate-900 mb-2">Add New Ingredient</h3>
                <p class="text-slate-500 text-sm mb-6">Use AI to automatically fill out nutrition, category, and unit
                    details.</p>

                <button type="button" onclick="analyzeIngredient()" id="btnAnalyze"
                    class="inline-flex items-center gap-2 rounded-full bg-orange-600 px-6 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-orange-500 transition-all hover:scale-105">
                    <span id="spinnerAnalyze"
                        class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                    <span>✨ Auto-Fill Details</span>
                </button>
            </div>
        </div>

        <!-- STEP 3: Edit & Save Form -->
        <div id="editSection" class="hidden mt-8 transition-all duration-500">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-semibold text-slate-900">Review & Save</h3>
                        <p class="text-xs text-slate-500">AI has proposed the following data.</p>
                    </div>
                    <span
                        class="inline-flex items-center rounded-md bg-purple-50 px-2 py-1 text-xs font-medium text-purple-700 ring-1 ring-inset ring-purple-700/10">AI
                        Generated</span>
                </div>

                <div class="p-6">
                    <form id="ingredientForm">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">

                            <!-- LEFT COLUMN: IMAGE Grid (4 cols on lg screens if we want, but let's do 4/12 split) -->
                            <div class="md:col-span-5 lg:col-span-4">
                                <label
                                    class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Select
                                    Best Image</label>

                                <!-- GRID OF 4 IMAGES -->
                                <div id="imageGrid" class="grid grid-cols-2 gap-3 mb-3">
                                    <!-- Populated via JS -->
                                    <!-- Placeholder / Loading State -->
                                    <div
                                        class="col-span-2 aspect-[4/3] bg-slate-100 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center p-4">
                                        <div id="imagePlaceholder" class="text-slate-400 text-center">
                                            <span class="text-xs">Generating 4 variants...</span>
                                            <div id="spinnerImage"
                                                class="mt-2 animate-spin h-5 w-5 border-2 border-orange-600 border-t-transparent rounded-full mx-auto">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <label for="imagePrompt"
                                        class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Visual
                                        Details</label>
                                    <textarea id="imagePrompt" rows="3"
                                        class="block w-full rounded-md border-slate-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 text-xs text-slate-600"
                                        placeholder="e.g. Fresh, vibrant, on a white background (The AI adds the 'Professional Photography' style automatically)"></textarea>
                                </div>

                                <div class="mt-3 text-center">
                                    <button type="button" id="btnGenImage" onclick="generateImage()"
                                        class="inline-flex items-center gap-2 rounded-md bg-white px-3 py-2 text-xs font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 w-full justify-center">
                                        <svg class="h-4 w-4 text-purple-600" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Regenerate Images (AI)
                                    </button>
                                </div>
                                <input type="hidden" id="tempImageFilename">
                            </div>

                            <!-- RIGHT COLUMNS: DATA -->
                            <div class="md:col-span-7 lg:col-span-8">
                                <div class="grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-6">

                                    <!-- Identity -->
                                    <div class="sm:col-span-6">
                                        <label for="ingName"
                                            class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Name</label>
                                        <input type="text" id="ingName"
                                            class="block w-full rounded-md border-0 py-2.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-lg font-semibold sm:leading-6">
                                    </div>

                                    <div class="sm:col-span-3">
                                        <label for="mainCategory"
                                            class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Category</label>
                                        <select id="mainCategory" onchange="updateSubCategories()"
                                            class="block w-full rounded-md border-0 py-2 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-sm sm:leading-6">
                                            <option value="" selected disabled>Select...</option>
                                            {% for cat in main_categories %}
                                            <option value="{{ cat }}">{{ cat | title }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="sm:col-span-3">
                                        <label for="subCategory"
                                            class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Sub
                                            Category</label>
                                        <select id="subCategory"
                                            class="block w-full rounded-md border-0 py-2 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-sm sm:leading-6">
                                            <option value="" selected>Select Main Category First</option>
                                        </select>
                                    </div>

                                    <!-- Measurement -->
                                    <div class="sm:col-span-3">
                                        <label for="unit"
                                            class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Unit</label>
                                        <select id="unit"
                                            class="block w-full rounded-md border-0 py-2 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-sm sm:leading-6">
                                            <option value="g">Grams (g)</option>
                                            <option value="ml">Milliliters (ml)</option>
                                            <option value="pcs">Pieces (pcs)</option>
                                            <option value="slice">Slice</option>
                                            <option value="cup">Cup</option>
                                        </select>
                                    </div>

                                    <div class="sm:col-span-3">
                                        <label for="avgGrams"
                                            class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Gram
                                            Weight (If Unit)</label>
                                        <div class="relative rounded-md shadow-sm">
                                            <input type="number" step="0.1" id="avgGrams"
                                                class="block w-full rounded-md border-0 py-1.5 pr-10 text-slate-900 ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-sm sm:leading-6">
                                            <div
                                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                                <span class="text-gray-500 sm:text-sm">g</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="sm:col-span-6 border-t border-slate-100 my-2"></div>

                                    <!-- Nutrition -->
                                    <div class="sm:col-span-6">
                                        <h4 class="text-sm font-semibold text-slate-900 mb-3">Nutrition (per 100g)</h4>
                                        <div class="grid grid-cols-4 gap-4">
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">Calories</label>
                                                <input type="number" id="cal"
                                                    class="block w-full rounded-md border-slate-300 text-sm py-1.5 focus:border-orange-500 focus:ring-orange-500">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">Protein</label>
                                                <input type="number" step="0.1" id="protein"
                                                    class="block w-full rounded-md border-slate-300 text-sm py-1.5 focus:border-orange-500 focus:ring-orange-500">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">Fat</label>
                                                <input type="number" step="0.1" id="fat"
                                                    class="block w-full rounded-md border-slate-300 text-sm py-1.5 focus:border-orange-500 focus:ring-orange-500">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">Carbs</label>
                                                <input type="number" step="0.1" id="carbs"
                                                    class="block w-full rounded-md border-slate-300 text-sm py-1.5 focus:border-orange-500 focus:ring-orange-500">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Paste Nutrition Section -->
                                    <div class="sm:col-span-6 mt-2 border-t border-slate-100 pt-2">
                                        <button type="button"
                                            onclick="document.getElementById('pasteNutritionPanel').classList.toggle('hidden')"
                                            class="flex items-center gap-2 text-xs font-bold text-indigo-600 hover:text-indigo-800 uppercase tracking-wide">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                                </path>
                                            </svg>
                                            Paste Nutrition Text
                                        </button>
                                        <div id="pasteNutritionPanel"
                                            class="hidden mt-2 p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                                            <textarea id="nutritionPasteArea" rows="4"
                                                class="block w-full rounded-md border-indigo-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-xs text-slate-600 mb-2"
                                                placeholder="Paste raw text here... e.g. 'Energy 254kcal, Fat 12g (of which saturates 2g), Carbs 30g...'"></textarea>
                                            <div class="flex justify-end">
                                                <button type="button" onclick="extractNutrients()"
                                                    id="btnExtractNutrients"
                                                    class="px-3 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded hover:bg-indigo-700 transition">
                                                    Extract & Fill
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div>

                        <!-- Hidden Fields for Advanced Macros -->
                        <input type="hidden" id="sugar" value="0">
                        <input type="hidden" id="fiber" value="0">
                        <input type="hidden" id="satFat" value="0">
                        <input type="hidden" id="sodium" value="0">

                        <!-- Sub-recipe link (Direction B) -->
                        <div class="mt-6 border-t border-slate-100 pt-6">
                            <label
                                class="block text-xs font-bold uppercase tracking-widest text-slate-400 mb-3">Sub-recipe
                                Link <span class="font-normal normal-case text-slate-400">(optional)</span></label>
                            <p class="text-xs text-slate-500 mb-3">Link this ingredient to a recipe that explains how to
                                make it (e.g. "Chilli Mayo", "Tortilla"). The ⓘ badge will appear on recipe pages.</p>
                            <div class="relative max-w-md">
                                <input type="text" id="subRecipeSearch" placeholder="Search recipes by name…"
                                    autocomplete="off" oninput="searchSubRecipe(this.value)"
                                    class="block w-full rounded-md border-slate-300 py-2 pl-3 pr-10 text-sm text-slate-900 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                <button type="button" onclick="clearSubRecipe()" id="subRecipeClearBtn"
                                    class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500 transition-colors"
                                    title="Remove link">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <!-- Dropdown -->
                                <div id="subRecipeDropdown"
                                    class="hidden absolute z-20 mt-1 w-full bg-white rounded-lg shadow-lg border border-slate-200 divide-y divide-slate-100 max-h-52 overflow-y-auto">
                                </div>
                            </div>
                            <!-- Linked badge -->
                            <div id="subRecipeLinked" class="hidden mt-2 flex items-center gap-2">
                                <span
                                    class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-orange-50 border border-orange-200 text-xs font-semibold text-orange-700">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Linked: <span id="subRecipeLinkedName"></span>
                                </span>
                            </div>
                            <input type="hidden" id="subRecipeId">
                        </div>

                        <div class="mt-8 flex items-center justify-end gap-3 pt-6 border-t border-slate-100">
                            <button type="button" onclick="window.location.reload()"
                                class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50">
                                Cancel
                            </button>
                            <button type="button" onclick="saveIngredient()"
                                class="rounded-md bg-slate-900 px-6 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-900">
                                Approve & Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- STEP 4: Merge / Map (Edit Mode Only) -->
        <div id="mergeSection" class="hidden mt-8 max-w-3xl mx-auto">
            <div class="bg-red-50 rounded-xl border border-red-100 p-6">

                <div class="flex items-start gap-4">
                    <div class="p-2 bg-red-100 rounded-full text-red-600">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-red-900 mb-1">Merge into another ingredient</h3>
                        <p class="text-sm text-red-700 mb-4">
                            Map all recipes using this ingredient to a different one, then delete this ingredient.
                            <span class="font-bold">This cannot be undone.</span>
                        </p>

                        <!-- Search -->
                        <div class="relative max-w-md">
                            <label class="block text-xs font-medium text-red-800 uppercase tracking-wider mb-1">Search
                                Target Ingredient</label>
                            <div class="flex gap-2">
                                <input type="text" id="mergeSearchInput"
                                    class="block w-full rounded-md border-red-200 py-2 text-slate-900 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm"
                                    placeholder="e.g. Table Salt"
                                    onkeydown="if(event.key === 'Enter') searchMergeTarget()">
                                <button type="button" onclick="searchMergeTarget()"
                                    class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-red-700 shadow-sm ring-1 ring-inset ring-red-300 hover:bg-red-50">
                                    Search
                                </button>
                            </div>

                            <!-- Search Results Dropdown -->
                            <div id="mergeSearchResults"
                                class="hidden mt-2 bg-white rounded-md shadow-lg border border-slate-200 divide-y divide-slate-100 max-h-60 overflow-y-auto">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Confirmation Panel -->
                        <div id="mergeConfirmation"
                            class="hidden mt-6 p-4 bg-white rounded-lg border-l-4 border-red-500 shadow-sm">
                            <p class="text-slate-900 text-sm">
                                Are you sure you want to merge
                                <strong class="bg-slate-100 px-1 rounded" id="mergeSourceName">Current</strong>
                                into
                                <strong class="bg-orange-100 px-1 rounded" id="mergeTargetName">Target</strong>?
                            </p>
                            <p class="text-xs text-slate-500 mt-1">
                                Recipes will be updated to use the target ingredient. The source ingredient will be
                                deleted.
                            </p>
                            <div class="mt-3 flex gap-3">
                                <button onclick="executeMerge()"
                                    class="rounded-md bg-red-600 px-4 py-2 text-xs font-bold text-white shadow-sm hover:bg-red-500">
                                    Confirm & Merge
                                </button>
                                <button onclick="cancelMerge()"
                                    class="text-xs text-slate-500 hover:text-slate-700 underline">
                                    Cancel
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Global State
    // Global State
    let EDIT_ID = null;
    let MERGE_TARGET_ID = null;
    let GENERATED_IMAGES = [];
    const SUB_CATEGORIES_MAP = {{ sub_categories_map | tojson }};

    function updateSubCategories(selectedSub = null) {
        const mainCat = document.getElementById('mainCategory').value;
        const subCatSelect = document.getElementById('subCategory');

        // Clear existing
        subCatSelect.innerHTML = '<option value="" selected disabled>Select...</option>';

        if (mainCat && SUB_CATEGORIES_MAP[mainCat]) {
            SUB_CATEGORIES_MAP[mainCat].forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.text = titleCase(sub);
                if (selectedSub && sub.toLowerCase() === selectedSub.toLowerCase()) {
                    option.selected = true;
                }
                subCatSelect.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = 'other';
            option.text = 'Other';
            subCatSelect.appendChild(option);
        }
    }

    function titleCase(str) {
        return str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
    }

    async function checkDuplicates() {
        const query = document.getElementById('userInput').value;
        if (!query) return;

        // UI Reset
        document.getElementById('editSection').classList.add('hidden');

        const btn = document.getElementById('btnSearch');
        const originalText = btn.innerText;
        btn.innerText = 'Checking...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/search-ingredients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });
            const res = await response.json();

            const list = document.getElementById('resultsList');
            list.innerHTML = '';

            if (res.results.length > 0) {
                document.getElementById('duplicatesCard').classList.remove('hidden');
                document.getElementById('noResultsMsg').classList.add('hidden');

                res.results.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "py-2 flex justify-between items-center";
                    div.innerHTML = `
                    <span class="text-sm font-medium text-slate-900">${item.name}</span>
                    <span class="text-xs text-slate-500 bg-white px-2 py-1 rounded border border-slate-200">${item.category || 'Uncategorized'}</span>
                `;
                    list.appendChild(div);
                });
            } else {
                document.getElementById('duplicatesCard').classList.add('hidden');
                document.getElementById('noResultsMsg').classList.remove('hidden');
            }

            document.getElementById('resultsSection').classList.remove('hidden');

        } catch (e) {
            console.error(e);
            alert("Search failed");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function analyzeIngredient() {
        const prompt = document.getElementById('userInput').value;
        const btn = document.getElementById('btnAnalyze');
        const spinner = document.getElementById('spinnerAnalyze');

        btn.disabled = true;
        spinner.classList.remove('hidden');

        try {
            const response = await fetch('/api/analyze-ingredient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });

            const result = await response.json();

            if (result.success) {
                populateForm(result.data);

                // Show Form
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('editSection').classList.remove('hidden');

                // Scroll to form
                document.getElementById('editSection').scrollIntoView({ behavior: 'smooth' });

                // AUTO START IMAGE GENERATION
                setTimeout(() => {
                    generateImage();
                }, 500);

            } else {
                alert('AI Analysis failed: ' + result.error);
            }

        } catch (error) {
            console.error(error);
            alert('An error occurred during analysis.');
        } finally {
            btn.disabled = false;
            spinner.classList.add('hidden');
        }
    }

    function populateForm(d) {
        document.getElementById('ingName').value = d.name || '';

        // Set Main Category
        const mainCatSelect = document.getElementById('mainCategory');
        mainCatSelect.value = d.main_category || '';

        // Trigger Sub Category Update
        updateSubCategories(d.sub_category);

        document.getElementById('unit').value = d.unit || 'g';
        document.getElementById('avgGrams').value = d.average_g_per_unit || '';

        document.getElementById('cal').value = d.calories_per_100g || 0;
        document.getElementById('protein').value = d.protein_per_100g || 0;
        document.getElementById('fat').value = d.fat_per_100g || 0;
        document.getElementById('carbs').value = d.carbs_per_100g || 0;

        document.getElementById('imagePrompt').value = d.image_prompt || '';

        // Fill hidden fields if available
        document.getElementById('sugar').value = d.sugar_per_100g || 0;
        document.getElementById('fiber').value = d.fiber_per_100g || 0;
        document.getElementById('satFat').value = d.fat_saturated_per_100g || 0;
        document.getElementById('sodium').value = d.sodium_mg_per_100g || 0;
    }

    async function generateImage() {
        const prompt = document.getElementById('imagePrompt').value;
        if (!prompt) { alert("No image prompt available."); return; }

        const btn = document.getElementById('btnGenImage');
        const grid = document.getElementById('imageGrid');

        // Reset Grid
        grid.innerHTML = `
        <div class="col-span-2 aspect-[4/3] bg-slate-100 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center p-4">
             <div class="text-slate-400 text-center">
                <span class="text-xs">Generating 4 variants...</span>
                <div class="mt-2 animate-spin h-5 w-5 border-2 border-orange-600 border-t-transparent rounded-full mx-auto"></div>
            </div>
        </div>`;

        btn.disabled = true;

        try {
            const response = await fetch('/api/generate-ingredient-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ingredient_name: document.getElementById('ingName').value,
                    prompt: prompt
                })
            });

            const result = await response.json();

            if (result.success) {
                GENERATED_IMAGES = result.images;
                renderImageGrid(result.images);

                if (result.images.length > 0) {
                    selectImage(0);
                }

            } else {
                alert('Image Generation failed: ' + result.error);
                grid.innerHTML = `<div class="col-span-2 text-xs text-red-500 p-2">Failed: ${result.error}</div>`;
            }
        } catch (e) {
            console.error(e);
            alert('Generation failed');
        } finally {
            btn.disabled = false;
        }
    }

    function renderImageGrid(images) {
        const grid = document.getElementById('imageGrid');
        grid.innerHTML = '';

        images.forEach((img, index) => {
            const div = document.createElement('div');
            div.className = "relative aspect-square rounded-lg overflow-hidden cursor-pointer group border-2 border-transparent hover:border-orange-300 transition-all";
            div.onclick = () => selectImage(index);
            div.id = `img-box-${index}`;

            div.innerHTML = `
            <img src="${img.url}" class="w-full h-full object-cover">
            <div id="check-${index}" class="absolute inset-0 bg-orange-500/20 hidden flex items-center justify-center">
                <div class="bg-orange-600 text-white rounded-full p-1 shadow-lg">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
            </div>
        `;
            grid.appendChild(div);
        });
    }

    function selectImage(index) {
        const imgData = GENERATED_IMAGES[index];
        document.getElementById('tempImageFilename').value = imgData.filename;

        GENERATED_IMAGES.forEach((_, idx) => {
            const box = document.getElementById(`img-box-${idx}`);
            const check = document.getElementById(`check-${idx}`);

            if (idx === index) {
                box.classList.add('border-orange-500');
                box.classList.remove('border-transparent');
                check.classList.remove('hidden');
            } else {
                box.classList.remove('border-orange-500');
                box.classList.add('border-transparent');
                check.classList.add('hidden');
            }
        });
    }

    // URL Logic
    window.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('query');
        const editId = urlParams.get('edit_id');

        if (editId) {
            EDIT_ID = editId;
            document.querySelector('h1').innerText = "Edit Ingredient";
            document.getElementById('userInput').value = "Loading...";

            try {
                const res = await fetch(`/api/ingredient/${editId}`);
                if (!res.ok) throw new Error("API responded with " + res.status);

                const result = await res.json();

                if (result.success) {
                    const data = result; // The API returns flattened data directly in the root or in 'data'? 
                    // Wait, my API implementation in app.py returns the dict directly as the JSON body.
                    // The API in app.py returns jsonify({...}) which IS the object.
                    // BUT some APIs return { success: true, data: { ... } }.
                    // Let's check app.py again.
                    // app.py: return jsonify({ 'success': True, 'id': ..., ... })
                    // So 'data' IS 'result'.

                    populateForm(result);
                    document.getElementById('userInput').value = result.name;

                    // Show sections
                    document.getElementById('editSection').classList.remove('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                    document.getElementById('editSection').classList.remove('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                    document.getElementById('createNewAction').classList.remove('hidden');
                    document.getElementById('mergeSection').classList.remove('hidden');

                    document.getElementById('mergeSourceName').innerText = result.name;
                } else {
                    throw new Error(result.error || "Unknown API error");
                }
            } catch (e) {
                console.error(e);
                alert("Failed to load ingredient for editing: " + e.message);
                document.getElementById('userInput').value = "Error loading data";
            }
        } else if (query) {
            document.getElementById('userInput').value = query;
            checkDuplicates();
        }
    });

    async function saveIngredient() {
        const name = document.getElementById('ingName').value;
        const mainCat = document.getElementById('mainCategory').value;

        if (!name) { alert("Please enter a name."); return; }
        if (!mainCat) { alert("Please select a main category."); return; }

        const data = {
            id: EDIT_ID,
            name: name,
            main_category: mainCat,
            sub_category: document.getElementById('subCategory').value,
            unit: document.getElementById('unit').value,
            average_g_per_unit: parseFloat(document.getElementById('avgGrams').value) || null,

            calories_per_100g: parseFloat(document.getElementById('cal').value) || 0,
            protein_per_100g: parseFloat(document.getElementById('protein').value) || 0,
            fat_per_100g: parseFloat(document.getElementById('fat').value) || 0,
            carbs_per_100g: parseFloat(document.getElementById('carbs').value) || 0,

            sugar_per_100g: parseFloat(document.getElementById('sugar').value) || 0,
            fiber_per_100g: parseFloat(document.getElementById('fiber').value) || 0,
            fat_saturated_per_100g: parseFloat(document.getElementById('satFat').value) || 0,
            sodium_mg_per_100g: parseFloat(document.getElementById('sodium').value) || 0,
            kj_per_100g: 0,

            image_prompt: document.getElementById('imagePrompt').value,
            temp_image_filename: document.getElementById('tempImageFilename').value,

            // Direction B: sub-recipe link
            sub_recipe_id: document.getElementById('subRecipeId').value || null,
        };

        const endpoint = EDIT_ID ? '/api/update-ingredient-data' : '/api/save-ingredient';

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                alert(EDIT_ID ? 'Ingredient updated!' : 'Ingredient saved!');
                window.location.href = '/ingredients';
            } else {
                alert('Error saving: ' + result.error);
            }
        } catch (error) {
            console.error(error);
            alert('Failed to save ingredient.');
        }
    }

    // Merge Functions
    async function searchMergeTarget() {
        const query = document.getElementById('mergeSearchInput').value;
        if (!query) return;

        try {
            const response = await fetch('/api/search-ingredients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });
            const res = await response.json();
            const list = document.getElementById('mergeSearchResults');
            list.innerHTML = '';
            list.classList.remove('hidden');

            if (res.results.length > 0) {
                res.results.forEach(item => {
                    // Don't show self
                    if (EDIT_ID && item.id == EDIT_ID) return;

                    const div = document.createElement('div');
                    div.className = "p-3 hover:bg-slate-50 cursor-pointer flex justify-between items-center group";
                    div.innerHTML = `
                        <div class="font-medium text-slate-900 group-hover:text-red-700">${item.name}</div>
                        <div class="text-xs text-slate-500">${item.category || 'Uncategorized'}</div>
                    `;
                    div.onclick = () => selectMergeTarget(item);
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = '<div class="p-3 text-sm text-slate-500">No ingredients found.</div>';
            }
        } catch (e) {
            alert("Search failed: " + e.message);
        }
    }

    function selectMergeTarget(item) {
        MERGE_TARGET_ID = item.id;
        document.getElementById('mergeTargetName').innerText = item.name;
        document.getElementById('mergeSearchResults').classList.add('hidden');
        document.getElementById('mergeConfirmation').classList.remove('hidden');
    }

    function cancelMerge() {
        MERGE_TARGET_ID = null;
        document.getElementById('mergeConfirmation').classList.add('hidden');
        document.getElementById('mergeSearchInput').value = '';
    }

    async function executeMerge() {
        if (!EDIT_ID || !MERGE_TARGET_ID) { alert("Missing IDs"); return; }

        if (!confirm("Are you ABSOLUTELY sure? This will update all recipes and DELETE the current ingredient.")) return;

        try {
            const response = await fetch('/api/merge-ingredients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    source_id: EDIT_ID,
                    target_id: MERGE_TARGET_ID
                })
            });
            const res = await response.json();

            if (res.success) {
                alert(res.message);
                window.location.href = '/ingredients';
            } else {
                alert("Merge failed: " + res.error);
            }
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    async function extractNutrients() {
        const text = document.getElementById('nutritionPasteArea').value;
        const name = document.getElementById('ingName').value;
        if (!text) return;

        const btn = document.getElementById('btnExtractNutrients');
        const originalText = btn.innerText;
        btn.innerText = 'Extracting...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/extract-nutrients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ raw_text: text, ingredient_name: name })
            });
            const res = await response.json();

            if (res.success && res.nutrients) {
                const n = res.nutrients;
                document.getElementById('cal').value = n.calories_per_100g || 0;
                document.getElementById('protein').value = n.protein_per_100g || 0;
                document.getElementById('fat').value = n.fat_per_100g || 0;
                document.getElementById('carbs').value = n.carbs_per_100g || 0;
                document.getElementById('sugar').value = n.sugar_per_100g || 0;
                document.getElementById('fiber').value = n.fiber_per_100g || 0;
                document.getElementById('satFat').value = n.fat_saturated_per_100g || 0;
                document.getElementById('sodium').value = n.sodium_mg_per_100g || 0;
                document.getElementById('pasteNutritionPanel').classList.add('hidden');
                ['cal', 'protein', 'fat', 'carbs'].forEach(id => {
                    const el = document.getElementById(id);
                    el.classList.add('ring-2', 'ring-green-500');
                    setTimeout(() => el.classList.remove('ring-2', 'ring-green-500'), 2000);
                });
            } else {
                alert('Could not extract nutrients: ' + (res.error || 'Unknown error'));
            }
        } catch (e) {
            console.error(e);
            alert('Extraction failed');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // ── Sub-recipe live search (Direction B) ────────────────────────────────
    let _srTimer = null;
    function searchSubRecipe(q) {
        clearTimeout(_srTimer);
        const drop = document.getElementById('subRecipeDropdown');
        if (q.length < 2) { drop.classList.add('hidden'); return; }
        _srTimer = setTimeout(async () => {
            try {
                const res = await fetch(`/api/search-recipes?q=${encodeURIComponent(q)}`);
                const data = await res.json();
                drop.innerHTML = '';
                if (!data.results || !data.results.length) {
                    drop.innerHTML = '<div class="px-4 py-3 text-xs text-slate-500">No recipes found</div>';
                } else {
                    data.results.forEach(r => {
                        const div = document.createElement('div');
                        div.className = 'px-4 py-2.5 hover:bg-orange-50 cursor-pointer flex items-center justify-between group';
                        const statusClass = r.status === 'approved'
                            ? 'bg-green-100 text-green-700'
                            : 'bg-slate-100 text-slate-500';
                        div.innerHTML = `
                            <span class="text-sm font-medium text-slate-900 group-hover:text-orange-700">${r.title}</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold uppercase tracking-wider ${statusClass}">${r.status}</span>`;
                        div.onclick = () => selectSubRecipe(r);
                        drop.appendChild(div);
                    });
                }
                drop.classList.remove('hidden');
            } catch (e) { console.error(e); }
        }, 250);
    }

    function selectSubRecipe(r) {
        document.getElementById('subRecipeId').value = r.id;
        document.getElementById('subRecipeSearch').value = r.title;
        document.getElementById('subRecipeDropdown').classList.add('hidden');
        document.getElementById('subRecipeClearBtn').classList.remove('hidden');
        document.getElementById('subRecipeLinkedName').textContent = r.title;
        document.getElementById('subRecipeLinked').classList.remove('hidden');
    }

    function clearSubRecipe() {
        document.getElementById('subRecipeId').value = '';
        document.getElementById('subRecipeSearch').value = '';
        document.getElementById('subRecipeClearBtn').classList.add('hidden');
        document.getElementById('subRecipeLinked').classList.add('hidden');
    }

    // Close dropdown on outside click
    document.addEventListener('click', e => {
        if (!e.target.closest('#subRecipeSearch') && !e.target.closest('#subRecipeDropdown')) {
            document.getElementById('subRecipeDropdown').classList.add('hidden');
        }
    });

    // Pre-populate sub-recipe field on edit-mode load
    const _origPopulateForm = typeof populateForm === 'function' ? populateForm : null;
    window.addEventListener('DOMContentLoaded', () => {
        // Patch: after main DOMContentLoaded loads the ingredient, check sub_recipe_id
        const origFetch = window._editIngredientFetch;
        // Simpler: observe EDIT_ID after load and fetch sub-recipe title if set
    });
    // We hook into the existing DOMContentLoaded fetch result via populateForm augmentation
    const _basePF = populateForm;
    window.populateForm = function (d) {
        _basePF(d);
        if (d.sub_recipe_id && d.sub_recipe_title) {
            selectSubRecipe({ id: d.sub_recipe_id, title: d.sub_recipe_title });
        }
    };
</script>
{% endblock %}