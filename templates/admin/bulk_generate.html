{% extends 'base.html' %}

{% block head %}
<!-- Use Bootstrap 5 for UI components as requested -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
<style>
    /* Reset some conflicting base tailwind styles strictly for the container */
    .bootstrap-scope h1,
    .bootstrap-scope h2,
    .bootstrap-scope h3 {
        margin-bottom: 0.5rem;
    }

    .bootstrap-scope table {
        border-collapse: separate;
        text-indent: initial;
    }
</style>
{% endblock %}

{% block content %}
<div class="bootstrap-scope container my-5">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3">Bulk Recipe Generation</h1>
            <p class="text-muted">Enter a list of dish names below. They will be generated sequentially to avoid API
                rate limits.</p>
        </div>
    </div>

    <!-- Input Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <label for="bulk-input" class="form-label fw-bold">List of Dish Ideas (one per line)</label>
                    <textarea class="form-control mb-3" id="bulk-input" rows="10"
                        placeholder="e.g.&#10;Spicy Chicken Tacos&#10;Vegan Mushroom Risotto&#10;Beef Wellington..."></textarea>

                    <button class="btn btn-primary" id="analyzeBtn">Analyze List</button>
                    <button class="btn btn-success" id="startBtn" style="display: none;">Start Generation
                        &#9654;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Queue Section -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold">
                    Processing Queue
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-borderless mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" width="10%">#</th>
                                    <th scope="col" width="30%">Idea Name</th>
                                    <th scope="col" width="20%">Status</th>
                                    <th scope="col" width="40%">Result Link</th>
                                </tr>
                            </thead>
                            <tbody id="queue-list">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <em>No ideas analyzed yet.</em>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const analyzeBtn = document.getElementById('analyzeBtn');
        const startBtn = document.getElementById('startBtn');
        const bulkInput = document.getElementById('bulk-input');
        const queueList = document.getElementById('queue-list');

        let ideasArray = [];

        // 1. Analyze Logic
        analyzeBtn.addEventListener('click', () => {
            const rawText = bulkInput.value;
            const lines = rawText.split('\n');

            // Trim whitespace and remove empty lines
            ideasArray = lines.map(l => l.trim()).filter(l => l.length > 0);

            queueList.innerHTML = '';

            if (ideasArray.length === 0) {
                queueList.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4"><em>No valid ideas found.</em></td></tr>';
                startBtn.style.display = 'none';
                return;
            }

            ideasArray.forEach((idea, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="fw-medium">${idea}</td>
                    <td id="status-${index}"><span class="badge bg-secondary">Pending</span></td>
                    <td id="link-${index}"><span class="text-muted">-</span></td>
                `;
                queueList.appendChild(tr);
            });

            startBtn.style.display = 'inline-block';
        });

        // 2. Generation Logic
        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            analyzeBtn.disabled = true;
            bulkInput.disabled = true;

            // Sequential for...of loop to avoid rate limits
            for (let i = 0; i < ideasArray.length; i++) {
                const idea = ideasArray[i];
                const statusTd = document.getElementById(`status-${i}`);
                const linkTd = document.getElementById(`link-${i}`);

                // Update UI to generating state
                statusTd.innerHTML = `
                    <span class="badge bg-warning text-dark d-flex align-items-center" style="width: 100px;">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> 
                        Generating...
                    </span>
                `;

                try {
                    const response = await fetch('/admin/api/generate-single-idea', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ idea: idea })
                    });

                    const data = await response.json();

                    if (data.success) {
                        statusTd.innerHTML = '<span class="badge bg-success">Success</span>';
                        linkTd.innerHTML = `<a href="/recipe/${data.recipe_id}" target="_blank" class="text-decoration-none fw-bold">View: "${data.recipe_title}" &#8594;</a>`;
                    } else {
                        statusTd.innerHTML = `<span class="badge bg-danger">Failed</span><div class="small text-danger mt-1">${data.error}</div>`;
                    }
                } catch (error) {
                    console.error('Network Error:', error);
                    statusTd.innerHTML = '<span class="badge bg-danger">Network Error</span>';
                }

                // Extremely short delay between requests just to ensure stack is clean
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            startBtn.disabled = false;
            analyzeBtn.disabled = false;
            bulkInput.disabled = false;
        });
    });
</script>
{% endblock %}