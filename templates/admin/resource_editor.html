{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">{% if resource %}Edit Resource{% else %}New Resource{% endif %}</h1>

    <div class="bg-white text-gray-800 rounded-lg shadow-xl p-6">
        <form method="POST" enctype="multipart/form-data">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Title</label>
                <input type="text" name="title" value="{{ resource.title if resource else '' }}"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Status</label>
                <select name="status"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="draft" {% if not resource or resource.status=='draft' %}selected{% endif %}>Draft
                    </option>
                    <option value="published" {% if resource and resource.status=='published' %}selected{% endif %}>
                        Published</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Slug</label>
                <input type="text" name="slug" value="{{ resource.slug if resource else '' }}"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="Leave blank to auto-generate from title">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Summary</label>
                <textarea name="summary"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    rows="3">{{ resource.summary if resource else '' }}</textarea>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Cover Image</label>
                {% if resource and resource.image_filename %}
                <div class="mb-2 text-sm text-gray-600">
                    Currently: <span class="font-mono">{{ resource.image_filename }}</span>
                </div>
                {% endif %}
                <input type="file" name="cover_image" accept="image/*"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Tags (comma separated)</label>
                <input type="text" name="tags" value="{{ resource.tags if resource else '' }}"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="skills, beginner">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Content (Markdown)</label>
                <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
                <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
                <textarea name="content_markdown"
                    id="markdown-editor">{{ resource.content_markdown if resource else '' }}</textarea>
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">Related Articles</label>
                <div class="checkbox-list border rounded p-4 h-48 overflow-y-scroll">
                    {% if all_resources %}
                    {% for other in all_resources %}
                    {% if not resource or other.id != resource.id %}
                    <div class="flex items-center mb-2">
                        <input type="checkbox" name="related_ids" value="{{ other.id }}" class="mr-2" {% if resource and
                            other in resource.related_resources %}checked{% endif %}>
                        <span>{{ other.title }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <p class="text-gray-500">No other resources available to link.</p>
                    {% endif %}
                </div>
            </div>

            <div class="flex items-center justify-between">
                <button type="submit"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Save
                    Article</button>
                <a href="{{ url_for('admin_resources_list') }}"
                    class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    // Define toolbar to customize the Upload button
    var toolbarOptions = [
        "bold", "italic", "heading", "|",
        "quote", "unordered-list", "ordered-list", "|",
        "link",
        {
            name: "upload-image",
            action: EasyMDE.drawUploadedImage,
            className: "fa fa-cloud-upload", // Use upload icon
            title: "Upload Image/Video",
        },
        "|",
        "preview", "side-by-side", "fullscreen", "|", "guide"
    ];

    window.easyMDE = new EasyMDE({
        element: document.getElementById("markdown-editor"),
        toolbar: toolbarOptions,
        uploadImage: true,
        imageUploadEndpoint: "/api/cms/upload-image",
        imageAccept: "image/png, image/jpeg, image/gif, video/mp4, video/quicktime",
        imageMaxSize: 10485760, // 10MB in bytes
        imageValidate: function (file) {
            if (file.size > 10 * 1024 * 1024) {
                alert("File too big! Max 10MB.");
                return false;
            }
            return (file.type && file.type.match(/(image|video)\/.*/)) ? true : false;
        },
        inputStyle: "contenteditable",
        previewClass: "prose prose-slate max-w-none p-4",
    });

    // Global Capture Handler for Drag and Drop
    window.addEventListener("drop", function (e) {
        // Check if drop is inside the CodeMirror editor
        if (e.target.closest(".CodeMirror")) {
            var files = e.dataTransfer.files;
            if (files.length > 0) {
                var file = files[0];
                if (file.type.indexOf("video") === 0) {
                    e.preventDefault();
                    e.stopPropagation(); // Stop EasyMDE from seeing it

                    if (file.size > 10 * 1024 * 1024) {
                        alert("File too big! Max 10MB.");
                        return;
                    }

                    // Show uploading text
                    var doc = window.easyMDE.codemirror.getDoc();
                    var cursor = doc.getCursor();
                    doc.replaceRange("![Uploading video...]()", cursor);

                    var formData = new FormData();
                    formData.append("image", file);

                    fetch("/api/cms/upload-image", {
                        method: "POST",
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log("Upload Response:", data); // DEBUG
                            if (data.data && data.data.filePath) {
                                var content = doc.getValue();
                                var filePath = data.data.filePath;

                                // Safety: If filePath is already absolute, ensure we don't double-prefix?
                                // Actually, just insert it as is.
                                // But if it's appearing with local prefix in DB, maybe we should strip it if it happens?
                                // No, let's just insert what we get (it should be correct).
                                // The issue might be that it WAS relative before?

                                var newContent = content.replace("![Uploading video...]()", "![](" + filePath + ")");
                                doc.setValue(newContent);
                            } else {
                                alert("Upload failed: " + (data.error || "Unknown error"));
                                var content = doc.getValue();
                                doc.setValue(content.replace("![Uploading video...]()", ""));
                            }
                        })
                        .catch(error => {
                            console.error("Error:", error);
                            alert("Upload error");
                        });
                }
            }
        }
    }, true); // Capture phase
</script>
{% endblock %}