{% extends "base.html" %}

{% block title %}Ingredients Management - The Lazy Chef{% endblock %}

{% block content %}
<div class="bg-white py-8 max-w-[95%] mx-auto">
    <div class="px-4 sm:px-6 lg:px-8">

        <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="sm:flex sm:items-center">
            <div class="sm:flex-auto">
                <h1 class="text-base font-semibold leading-6 text-gray-900">Ingredients Management</h1>
                <p class="mt-2 text-sm text-gray-700">
                    Manage the lifecycle, images, and data for every ingredient in the pantry.
                </p>
            </div>
            <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
                <span
                    class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-semibold text-gray-600">
                    {{ pagination.total }} ingredients
                </span>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Quick-filter Action Bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="mt-4 flex flex-wrap items-center gap-3">
            <a href="{{ url_for('ingredients_mgmt.dashboard') }}"
                class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold shadow-sm ring-1 ring-inset transition-colors
                      {{ 'bg-indigo-600 text-white ring-indigo-600' if not selected_statuses and not selected_categories and not selected_sub_cats and not selected_basic and not missing_images else 'bg-white text-gray-900 ring-gray-300 hover:bg-gray-50' }}">
                All
            </a>
            <a href="{{ url_for('ingredients_mgmt.dashboard', missing_images='1') }}"
                class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold shadow-sm ring-1 ring-inset transition-colors
                      {{ 'bg-indigo-600 text-white ring-indigo-600' if missing_images else 'bg-white text-gray-900 ring-gray-300 hover:bg-gray-50' }}">
                üñºÔ∏è Missing Images
            </a>

            <div class="ml-auto flex items-center gap-3">
                <!-- Apply Filters button ‚Äî shown when filter checkboxes change -->
                <button id="apply-filters-btn" onclick="applyFilters()"
                    class="hidden inline-flex items-center gap-2 rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 transition-colors">
                    Apply Filters
                </button>
                <button id="bulk-regen-btn" onclick="bulkRegenerate()" disabled
                    class="inline-flex items-center gap-2 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10" />
                        <polyline points="1 20 1 14 7 14" />
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                    </svg>
                    Regen Selected
                </button>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <!-- Header-cell macro: label + sortable + filter dropdown     -->
        <!-- Same pattern as recipe-scoring                             -->
        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        {% macro header_cell(col_id, label, options, selected_values) %}
        <th scope="col"
            class="py-3.5 pl-4 pr-3 text-left text-xs font-semibold text-gray-900 sm:pl-6 group relative whitespace-nowrap">
            <div class="flex items-center gap-2">
                <span>{{ label }}</span>

                {% if options %}
                <div class="relative inline-block text-left filter-dropdown-container">
                    <button type="button" onclick="toggleFilterMenu('menu-{{ col_id }}')"
                        class="text-gray-400 hover:text-indigo-600 focus:outline-none">
                        <svg class="h-4 w-4 {% if selected_values %}text-indigo-600{% endif %}" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
                        </svg>
                    </button>

                    <div id="menu-{{ col_id }}"
                        class="hidden absolute left-0 z-20 mt-2 w-56 origin-top-left rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
                        <div
                            class="p-2 border-b border-gray-100 flex justify-between text-xs font-semibold text-indigo-600 bg-gray-50">
                            <span class="cursor-pointer hover:underline"
                                onclick="selectAllFilters('{{ col_id }}')">All</span>
                            <span class="cursor-pointer hover:underline"
                                onclick="clearFilters('{{ col_id }}')">None</span>
                        </div>
                        <div class="max-h-60 overflow-y-auto p-1">
                            {% for opt in options %}
                            <div class="flex items-center px-4 py-2 hover:bg-gray-50">
                                <input type="checkbox" data-col="{{ col_id }}" value="{{ opt }}" {% if opt in
                                    selected_values %}checked{% endif %}
                                    class="filter-cb h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600">
                                <label class="ml-3 block text-sm text-gray-700 whitespace-normal">{{ opt }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </th>
        {% endmacro %}

        <!-- ‚îÄ‚îÄ Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="mt-8 flow-root">
            <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <!-- Master Checkbox -->
                                    <th scope="col" class="relative px-3 sm:w-12 sm:px-6">
                                        <input type="checkbox" id="master-cb"
                                            class="absolute left-4 top-1/2 -mt-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 sm:left-6"
                                            onchange="toggleAll(this.checked)">
                                    </th>
                                    <!-- Static columns -->
                                    <th scope="col"
                                        class="py-3.5 pl-4 pr-3 text-left text-xs font-semibold text-gray-900 sm:pl-6 whitespace-nowrap">
                                        Image</th>
                                    <th scope="col"
                                        class="py-3.5 pl-4 pr-3 text-left text-xs font-semibold text-gray-900 sm:pl-6 whitespace-nowrap">
                                        Name</th>
                                    <!-- Filterable columns -->
                                    {{ header_cell('status', 'Status', ['active','pending','inactive'],
                                    selected_statuses) }}
                                    {{ header_cell('category', 'Category', category_options, selected_categories) }}
                                    {{ header_cell('sub_category', 'Sub-Category', sub_category_options,
                                    selected_sub_cats) }}
                                    {{ header_cell('basic', 'Basic?', ['yes','no'], selected_basic) }}
                                    <!-- QA Score Columns -->
                                    <th scope="col"
                                        class="py-3.5 pl-3 pr-2 text-left text-xs font-semibold text-gray-900 whitespace-nowrap">
                                        Total</th>
                                    <th scope="col"
                                        class="py-3.5 px-2 text-left text-xs font-semibold text-gray-500 whitespace-nowrap"
                                        title="Image Relevance">üñº Img</th>
                                    <th scope="col"
                                        class="py-3.5 px-2 text-left text-xs font-semibold text-gray-500 whitespace-nowrap"
                                        title="Nutritional Plausibility">ü•ó Nutr</th>
                                    <th scope="col"
                                        class="py-3.5 px-2 text-left text-xs font-semibold text-gray-500 whitespace-nowrap"
                                        title="Taxonomy Fit">üè∑ Tax</th>
                                    <th scope="col"
                                        class="py-3.5 px-2 text-left text-xs font-semibold text-gray-500 whitespace-nowrap"
                                        title="Unit & Utility Logic">‚öñÔ∏è Unit</th>
                                    <th scope="col"
                                        class="py-3.5 px-2 text-left text-xs font-semibold text-gray-400 whitespace-nowrap"
                                        title="Global Commonness (informational)">üåç Com</th>
                                    <!-- Actions -->
                                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                {% for ing in ingredients %}
                                <tr id="row-{{ ing.id }}" class="hover:bg-gray-50 transition-colors">

                                    <!-- Checkbox -->
                                    <td class="relative px-3 sm:w-12 sm:px-6">
                                        <div
                                            class="absolute inset-y-0 left-0 w-0.5 bg-indigo-600 opacity-0 transition-opacity row-indicator">
                                        </div>
                                        <input type="checkbox"
                                            class="row-cb absolute left-4 top-1/2 -mt-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 sm:left-6"
                                            value="{{ ing.id }}" onchange="onRowCheck()">
                                    </td>

                                    <!-- Image -->
                                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                                        <div class="h-10 w-10 shrink-0">
                                            {% if ing.image_url %}
                                            <img id="img-{{ ing.id }}" src="{{ ing.image_url }}" alt="{{ ing.name }}"
                                                class="h-10 w-10 rounded-full object-cover"
                                                onerror="this.style.display='none'; document.getElementById('ph-{{ ing.id }}').style.display='flex';">
                                            <div id="ph-{{ ing.id }}"
                                                class="h-10 w-10 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-400"
                                                style="display:none;">
                                                {{ ing.name[:2]|upper }}
                                            </div>
                                            {% else %}
                                            <div id="ph-{{ ing.id }}"
                                                class="h-10 w-10 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-400">
                                                {{ ing.name[:2]|upper }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </td>

                                    <!-- Name -->
                                    <td
                                        class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6 max-w-xs">
                                        {{ ing.name }} <span class="ml-1 text-xs text-gray-400 font-normal">#{{ ing.id
                                            }}</span>
                                        <br>
                                        <span class="font-mono text-xs text-gray-400">{{ ing.food_id }}</span>
                                    </td>

                                    <!-- Status Dropdown -->
                                    <td class="whitespace-nowrap px-3 py-4 text-sm">
                                        <select
                                            class="ing-status-dropdown block w-full rounded-md border-0 py-1 pl-2 pr-7 text-xs font-semibold ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 transition-all"
                                            data-ing-id="{{ ing.id }}" data-previous-value="{{ ing.status }}"
                                            style="min-width:135px">
                                            <option value="active" {% if ing.status=='active' %}selected{% endif %}>‚úÖ
                                                Active</option>
                                            <option value="pending" {% if ing.status=='pending' %}selected{% endif %}>‚è≥
                                                Pending</option>
                                            <option value="inactive" {% if ing.status=='inactive' %}selected{% endif %}>
                                                üö´ Inactive</option>
                                        </select>
                                    </td>

                                    <!-- Category -->
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                        {{ ing.main_category or '‚Äî' }}
                                    </td>

                                    <!-- Sub-Category (separate column) -->
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-400">
                                        {{ ing.sub_category or '‚Äî' }}
                                    </td>

                                    <!-- Basic? -->
                                    <td class="whitespace-nowrap px-3 py-4 text-sm">
                                        {% if ing.is_basic_ingredient %}
                                        <span
                                            class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">‚≠ê
                                            Yes</span>
                                        {% else %}
                                        <span class="text-gray-300">‚Äî</span>
                                        {% endif %}
                                    </td>

                                    {% if ing.evaluation %}
                                    {% set ev = ing.evaluation %}
                                    {% set qa_details = ev.evaluation_details | tojson | forceescape %}

                                    {# Macro: colour-coded score cell #}
                                    {% macro score_cell(val) %}
                                    <td class="whitespace-nowrap px-2 py-4 text-sm font-bold
                                        {% if val is none %}text-gray-300
                                        {% elif val >= 80 %}text-green-600
                                        {% elif val >= 60 %}text-amber-500
                                        {% else %}text-red-600{% endif %}">
                                        {{ val if val is not none else '‚Äî' }}
                                    </td>
                                    {% endmacro %}

                                    <!-- Total Score + Re-run button -->
                                    <td class="whitespace-nowrap pl-3 pr-2 py-4 text-sm" id="qa-cell-{{ ing.id }}">
                                        <div class="flex items-center gap-1.5">
                                            <span class="font-bold
                                                {% if ev.total_score >= 80 %}text-green-600
                                                {% elif ev.total_score >= 60 %}text-amber-500
                                                {% else %}text-red-600{% endif %}">
                                                {{ ev.total_score|round(1) }}
                                            </span>
                                            <button onclick="runQA({{ ing.id }}, '{{ ing.name|e }}', this)"
                                                title="Re-run QA (overwrites existing score)"
                                                class="text-gray-300 hover:text-indigo-500 transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="23 4 23 10 17 10" />
                                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                    <!-- Individual scores -->
                                    {{ score_cell(ev.score_image) }}
                                    {{ score_cell(ev.score_nutrition) }}
                                    {{ score_cell(ev.score_taxonomy) }}
                                    {{ score_cell(ev.score_utility) }}
                                    <!-- Commonness (informational, greyed) -->
                                    <td class="whitespace-nowrap px-2 py-4 text-sm font-bold text-gray-400">
                                        {{ ev.score_commonness if ev.score_commonness is not none else '‚Äî' }}
                                    </td>

                                    {% else %}
                                    <!-- No evaluation yet ‚Äî Run QA button in Total col, blanks for rest -->
                                    <td class="whitespace-nowrap pl-3 pr-2 py-4 text-sm" id="qa-cell-{{ ing.id }}">
                                        <button onclick="runQA({{ ing.id }}, '{{ ing.name|e }}', this)"
                                            class="inline-flex items-center gap-1 rounded-md bg-white px-2 py-1 text-xs font-semibold text-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path
                                                    d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" />
                                            </svg>
                                            Run QA
                                        </button>
                                    </td>
                                    <td class="text-gray-200 px-2 py-4 text-sm">‚Äî</td>
                                    <td class="text-gray-200 px-2 py-4 text-sm">‚Äî</td>
                                    <td class="text-gray-200 px-2 py-4 text-sm">‚Äî</td>
                                    <td class="text-gray-200 px-2 py-4 text-sm">‚Äî</td>
                                    <td class="text-gray-200 px-2 py-4 text-sm">‚Äî</td>
                                    {% endif %}

                                    <!-- Actions -->
                                    <td
                                        class="relative whitespace-nowrap py-4 pl-3 pr-4 text-center text-sm font-medium sm:pr-6">
                                        <!-- Inspector -->
                                        <button onclick="inspectIngredient({{ ing.id }})"
                                            class="text-gray-400 hover:text-indigo-600 transition-colors"
                                            title="Inspect raw data">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                            </svg>
                                        </button>
                                        <!-- QA reasoning report (only when evaluation exists) -->
                                        {% if ing.evaluation %}
                                        <button data-ing-id="{{ ing.id }}" data-ing-name="{{ ing.name|e }}"
                                            data-qa-score="{{ ing.evaluation.total_score }}"
                                            data-qa-details="{{ ing.evaluation.evaluation_details | tojson | forceescape }}"
                                            onclick="openQaReport(this)"
                                            class="ml-3 text-blue-400 hover:text-blue-600 transition-colors"
                                            title="View QA Reasoning">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                fill="currentColor" viewBox="0 0 16 16">
                                                <path
                                                    d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                                <path
                                                    d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0" />
                                            </svg>
                                        </button>
                                        {% else %}
                                        <span class="ml-3 w-4 inline-block"></span>
                                        {% endif %}
                                        <!-- Regen image -->
                                        <button onclick="regenImage({{ ing.id }}, this)"
                                            class="ml-3 text-gray-400 hover:text-indigo-600 transition-colors"
                                            title="Regenerate image">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="23 4 23 10 17 10" />
                                                <polyline points="1 20 1 14 7 14" />
                                                <path
                                                    d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                                            </svg>
                                        </button>
                                        <!-- Delete / archive -->
                                        <button onclick="deleteIngredient({{ ing.id }}, '{{ ing.name|e }}')"
                                            class="ml-3 text-red-400 hover:text-red-700 transition-colors"
                                            title="Delete or archive">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="9" class="py-10 text-center text-sm text-gray-400">No ingredients match
                                        the current filters.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ Pagination ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
{% if pagination.pages > 1 %}
<div class="max-w-[95%] mx-auto px-4 sm:px-6 lg:px-8 mt-4 mb-10 flex items-center justify-between">
    <p class="text-sm text-gray-600">
        Showing <strong>{{ (pagination.page - 1) * pagination.per_page + 1 }}</strong>
        &ndash;
        <strong>{{ [(pagination.page * pagination.per_page), pagination.total] | min }}</strong>
        of <strong>{{ pagination.total }}</strong> ingredients
    </p>
    <div class="flex items-center gap-1">
        {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}"
            class="px-3 py-1.5 text-sm font-medium rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">&larr;
            Prev</a>
        {% endif %}
        {% for p in pagination.iter_pages(left_edge=1, left_current=2, right_current=2, right_edge=1) %}
        {% if p %}
        <a href="?page={{ p }}"
            class="px-3 py-1.5 text-sm font-medium rounded-md border transition-colors {{ 'bg-indigo-600 text-white border-indigo-600' if p == pagination.page else 'border-gray-300 bg-white text-gray-700 hover:bg-gray-50' }}">
            {{ p }}
        </a>
        {% else %}
        <span class="px-2 text-gray-400">&hellip;</span>
        {% endif %}
        {% endfor %}
        {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}"
            class="px-3 py-1.5 text-sm font-medium rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">Next
            &rarr;</a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- ‚îÄ‚îÄ Floating Apply Filters Button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="filter-actions" class="fixed bottom-8 right-8 hidden z-50">
    <button onclick="applyFilters()"
        class="rounded-full bg-indigo-600 px-6 py-3 text-base font-semibold text-white shadow-xl hover:bg-indigo-500 transition-all flex items-center gap-2">
        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
                clip-rule="evenodd" />
        </svg>
        Apply Filters
    </button>
</div>

<!-- ‚îÄ‚îÄ Bulk Action Bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="bulk-action-bar"
    class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] py-4 transform translate-y-full transition-transform duration-300 z-50 flex items-center justify-between pointer-events-none data-[visible=true]:translate-y-0 data-[visible=true]:pointer-events-auto">
    <div class="max-w-7xl mx-auto w-full flex items-center justify-between px-6 lg:px-8">
        <div class="flex items-center gap-4">
            <span class="text-sm font-semibold text-gray-700" id="selection-count">0 Selected</span>
            <button onclick="clearSelection()"
                class="text-sm text-gray-500 hover:text-gray-900 underline">Cancel</button>
        </div>
        <button type="button" onclick="bulkRegenerate()"
            class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 transition-colors">
            ‚ö° Regenerate Images
        </button>
    </div>
</div>

<!-- ‚îÄ‚îÄ Inspector Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="inspector-modal" class="relative z-[60] hidden" aria-modal="true" role="dialog">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-gray-200">
                <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-gray-200">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Ingredient Inspector</h3>
                    <button type="button" onclick="closeInspector()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="px-4 py-4 sm:px-6">
                    <div class="grid grid-cols-2 gap-4 sm:grid-cols-4 bg-gray-50 p-4 rounded-md mb-4">
                        <div><span class="block text-xs font-medium text-gray-500">ID</span><span
                                class="block text-sm font-bold text-gray-900" id="insp-id">‚Äî</span></div>
                        <div><span class="block text-xs font-medium text-gray-500">Status</span><span
                                class="block text-sm font-bold text-gray-900" id="insp-status">‚Äî</span></div>
                        <div><span class="block text-xs font-medium text-gray-500">Category</span><span
                                class="block text-sm font-bold text-gray-900" id="insp-cat">‚Äî</span></div>
                        <div><span class="block text-xs font-medium text-gray-500">Used in Recipes</span><span
                                class="block text-sm font-bold text-gray-900" id="insp-recipes">‚Äî</span></div>
                    </div>
                    <div class="bg-slate-900 rounded-md p-4 overflow-auto max-h-[500px]">
                        <pre id="insp-json" class="text-xs text-green-400 font-mono whitespace-pre-wrap">Loading‚Ä¶</pre>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" onclick="closeInspector()"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ Scripts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
    const API = '/admin/ingredients-management/api';

    // ‚îÄ‚îÄ Filter menus ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleFilterMenu(menuId) {
        document.querySelectorAll('[id^="menu-"]').forEach(el => {
            if (el.id !== menuId) el.classList.add('hidden');
        });
        document.getElementById(menuId).classList.toggle('hidden');
    }

    document.querySelectorAll('.filter-cb').forEach(cb => {
        cb.addEventListener('change', () => {
            document.getElementById('filter-actions').classList.remove('hidden');
        });
    });

    function selectAllFilters(colId) {
        document.querySelectorAll(`input[data-col="${colId}"]`).forEach(i => i.checked = true);
        document.getElementById('filter-actions').classList.remove('hidden');
    }

    function clearFilters(colId) {
        document.querySelectorAll(`input[data-col="${colId}"]`).forEach(i => i.checked = false);
        document.getElementById('filter-actions').classList.remove('hidden');
    }

    // Collect ALL checked boxes across all filter columns and reload
    function applyFilters() {
        const params = new URLSearchParams();
        // preserve missing_images
        const url = new URLSearchParams(window.location.search);
        if (url.get('missing_images') === '1') params.set('missing_images', '1');

        const colMap = {};
        document.querySelectorAll('.filter-cb:checked').forEach(cb => {
            const col = cb.dataset.col;
            if (!colMap[col]) colMap[col] = [];
            colMap[col].push(cb.value);
        });
        Object.entries(colMap).forEach(([col, vals]) => {
            vals.forEach(v => params.append(col, v));
        });

        window.location.search = params.toString();
    }

    // Close dropdown on outside click
    document.addEventListener('click', e => {
        if (!e.target.closest('.filter-dropdown-container')) {
            document.querySelectorAll('[id^="menu-"]').forEach(el => el.classList.add('hidden'));
        }
    });

    // ‚îÄ‚îÄ Status Dropdown (mirrors recipe-scoring exactly) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ING_STATUS_STYLES = {
        active: 'ring-green-500 text-green-700',
        pending: 'ring-amber-400 text-amber-700',
        inactive: 'ring-red-400 text-red-600',
    };

    function applyIngStatusStyle(select, status) {
        Object.values(ING_STATUS_STYLES).forEach(cls =>
            cls.split(' ').forEach(c => select.classList.remove(c))
        );
        (ING_STATUS_STYLES[status] || ING_STATUS_STYLES.active).split(' ').forEach(c =>
            select.classList.add(c)
        );
    }

    document.querySelectorAll('.ing-status-dropdown').forEach(s => applyIngStatusStyle(s, s.value));

    document.addEventListener('change', async function (e) {
        const select = e.target.closest('.ing-status-dropdown');
        if (!select) return;

        const id = select.dataset.ingId;
        const newStatus = select.value;
        const prev = select.dataset.previousValue;

        applyIngStatusStyle(select, newStatus);
        select.disabled = true;

        try {
            const res = await fetch(`${API}/${id}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus }),
            });
            const data = await res.json();
            if (data.success) {
                select.classList.add('ring-2', 'ring-green-500');
                setTimeout(() => {
                    select.classList.remove('ring-2', 'ring-green-500');
                    applyIngStatusStyle(select, data.new_status);
                }, 1200);
                select.dataset.previousValue = data.new_status;
            } else {
                alert(`Failed: ${data.error}`);
                select.value = prev;
                applyIngStatusStyle(select, prev);
            }
        } catch {
            alert('Network error updating status.');
            select.value = prev;
            applyIngStatusStyle(select, prev);
        } finally {
            select.disabled = false;
        }
    });

    // ‚îÄ‚îÄ Delete / Archive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function deleteIngredient(id, name) {
        if (!confirm(`Delete "${name}"?\n\n‚Ä¢ Used in recipes ‚Üí archived as 'inactive'\n‚Ä¢ Unused ‚Üí permanently deleted`)) return;
        try {
            const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (!data.success) { alert(`Error: ${data.error}`); return; }
            if (data.action === 'archived') {
                const row = document.getElementById(`row-${id}`);
                if (row) { const sel = row.querySelector('.ing-status-dropdown'); if (sel) { sel.value = 'inactive'; applyIngStatusStyle(sel, 'inactive'); } }
                showToast(`‚ö†Ô∏è ${data.message}`, 'warning');
            } else {
                const row = document.getElementById(`row-${id}`);
                if (row) { row.style.transition = 'opacity 0.4s'; row.style.opacity = '0'; setTimeout(() => row.remove(), 400); }
                showToast(`"${name}" permanently deleted.`);
            }
        } catch { alert('Network error during delete.'); }
    }

    // ‚îÄ‚îÄ Inspector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function inspectIngredient(id) {
        document.getElementById('insp-json').textContent = 'Loading‚Ä¶';
        ['insp-id', 'insp-status', 'insp-cat', 'insp-recipes'].forEach(el => document.getElementById(el).textContent = '‚Äî');
        document.getElementById('inspector-modal').classList.remove('hidden');
        try {
            const res = await fetch(`${API}/${id}/inspect`);
            const data = await res.json();
            if (data.success) {
                const i = data.ingredient;
                document.getElementById('insp-id').textContent = i.id;
                document.getElementById('insp-status').textContent = i.status;
                document.getElementById('insp-cat').textContent = i.main_category || '‚Äî';
                document.getElementById('insp-recipes').textContent = i.recipe_count;
                document.getElementById('insp-json').textContent = JSON.stringify(i, null, 2);
            } else {
                document.getElementById('insp-json').textContent = `Error: ${data.error}`;
            }
        } catch (e) { document.getElementById('insp-json').textContent = `Fetch error: ${e.message}`; }
    }

    function closeInspector() { document.getElementById('inspector-modal').classList.add('hidden'); }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeInspector(); });

    // ‚îÄ‚îÄ Regen single image ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function regenImage(id, btn) {
        const orig = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>';
        try {
            const res = await fetch(`${API}/${id}/regenerate-image`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                const img = document.getElementById(`img-${id}`);
                const ph = document.getElementById(`ph-${id}`);
                if (img) { img.src = data.image_url + '?t=' + Date.now(); img.style.display = ''; if (ph) ph.style.display = 'none'; }
                else if (ph) { ph.insertAdjacentHTML('beforebegin', `<img id="img-${id}" src="${data.image_url}" class="h-10 w-10 rounded-full object-cover">`); ph.style.display = 'none'; }
                showToast('‚úÖ Image regenerated!');
            } else { showToast(`Image failed: ${data.error}`, 'error'); }
        } catch { showToast('Network error.', 'error'); }
        finally { btn.disabled = false; btn.innerHTML = orig; }
    }

    // ‚îÄ‚îÄ Bulk Selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const selectedIds = new Set();
    const bulkBar = document.getElementById('bulk-action-bar');
    const selCount = document.getElementById('selection-count');
    const bulkBtn = document.getElementById('bulk-regen-btn');

    function onRowCheck() {
        selectedIds.clear();
        document.querySelectorAll('.row-cb:checked').forEach(cb => selectedIds.add(parseInt(cb.value)));
        updateBulkUI();
    }

    function toggleAll(checked) {
        document.querySelectorAll('.row-cb').forEach(cb => {
            cb.checked = checked;
            cb.closest('tr').classList.toggle('bg-gray-50', checked);
        });
        onRowCheck();
    }

    function clearSelection() { document.getElementById('master-cb').checked = false; toggleAll(false); }

    function updateBulkUI() {
        const n = selectedIds.size;
        selCount.textContent = `${n} Selected`;
        if (n > 0) { bulkBar.setAttribute('data-visible', 'true'); if (bulkBtn) bulkBtn.disabled = false; }
        else { bulkBar.setAttribute('data-visible', 'false'); if (bulkBtn) bulkBtn.disabled = true; }
    }

    // ‚îÄ‚îÄ Bulk Regenerate (sequential) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function bulkRegenerate() {
        const ids = Array.from(selectedIds);
        if (!ids.length) return;
        if (!confirm(`Regenerate images for ${ids.length} ingredient(s)? This may take a while.`)) return;

        showToast(`Starting bulk regen for ${ids.length} ingredients‚Ä¶`, 'info');
        let ok = 0, fail = 0;
        for (const id of ids) {
            try {
                const res = await fetch(`${API}/${id}/regenerate-image`, { method: 'POST' });
                const data = await res.json();
                if (data.success) { ok++; const img = document.getElementById(`img-${id}`); if (img) img.src = data.image_url + '?t=' + Date.now(); }
                else fail++;
            } catch { fail++; }
        }
        showToast(`‚úÖ Done! ${ok} ok, ${fail} failed.`, fail > 0 ? 'warning' : 'success');
        clearSelection();
    }

    // ‚îÄ‚îÄ QA Evaluation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function runQA(id, name, btn) {
        if (!confirm(`Run LLM QA evaluation on "${name}"?\nThis calls Gemini with the ingredient image and metadata.`)) return;
        const orig = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg> Scoring‚Ä¶';
        try {
            const res = await fetch(`${API}/${id}/evaluate`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                const score = data.total_score;
                let colorClass = score >= 80
                    ? 'bg-green-50 text-green-700 ring-green-600/20'
                    : score >= 60
                        ? 'bg-amber-50 text-amber-700 ring-amber-600/20'
                        : 'bg-red-50 text-red-700 ring-red-600/10';
                // Replace the cell contents with a badge (no page reload)
                const cell = document.getElementById(`qa-cell-${id}`);
                if (cell) {
                    cell.textContent = score;
                    cell.className = (cell.className || '')
                        .replace(/text-\S+/g, '')
                        + (score >= 80 ? ' text-green-600' : score >= 60 ? ' text-amber-500' : ' text-red-600')
                        + ' whitespace-nowrap pl-3 pr-2 py-4 text-sm font-bold';
                }
                const promoted = data.auto_promoted ? ' (auto-promoted to Active ‚úÖ)' : '';
                showToast(`QA complete! Score: ${score}${promoted} ‚Äî reloading‚Ä¶`, score >= 80 ? 'success' : 'warning');
                // Reload after a short delay so all 6 score columns populate from the server
                setTimeout(() => window.location.reload(), 1800);
            } else {
                showToast(`QA failed: ${data.error}`, 'error');
                btn.disabled = false; btn.innerHTML = orig;
            }
        } catch (e) {
            showToast('Network error during QA.', 'error');
            btn.disabled = false; btn.innerHTML = orig;
        }
    }

    // ‚îÄ‚îÄ QA Report Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openQaReport(btn) {
        let details = {};
        try {
            const parser = new DOMParser();
            const decoded = parser.parseFromString(btn.dataset.qaDetails, 'text/html').documentElement.textContent;
            details = JSON.parse(decoded);
        } catch (e) { console.error('Could not parse QA details', e); }

        const score = parseFloat(btn.dataset.qaScore);
        const name = btn.dataset.ingName;

        document.getElementById('qa-modal-title').textContent = `QA Report: ${name}`;
        const scoreEl = document.getElementById('qa-modal-score');
        scoreEl.textContent = `Total Score: ${score} / 100 (avg of image, nutrition, taxonomy, utility)`;
        scoreEl.className = 'font-bold mb-4 pb-2 border-b border-gray-200 ' +
            (score >= 80 ? 'text-green-600' : score >= 60 ? 'text-amber-600' : 'text-red-600');

        const mapping = [
            { label: 'üñºÔ∏è Image Relevance', reasoning: 'reasoning_image', scoreKey: 'score_image', noted: false },
            { label: 'ü•ó Nutritional Plausibility', reasoning: 'reasoning_nutrition', scoreKey: 'score_nutrition', noted: false },
            { label: 'üè∑Ô∏è Taxonomy Fit', reasoning: 'reasoning_taxonomy', scoreKey: 'score_taxonomy', noted: false },
            { label: '‚öñÔ∏è Unit & Utility Logic', reasoning: 'reasoning_utility', scoreKey: 'score_utility', noted: false },
            { label: 'üåç Global Commonness', reasoning: 'reasoning_commonness', scoreKey: 'score_commonness', noted: true },
        ];

        // Fetch the individual scores from the button's sibling cells in the row
        // They were embedded as data-* on the btn for us to use
        const ingId = btn.dataset.ingId;
        const scoreMap = {
            score_image: parseInt(document.querySelector(`#row-${ingId} td:nth-child(9)`)?.textContent?.trim()) || null,
            score_nutrition: parseInt(document.querySelector(`#row-${ingId} td:nth-child(10)`)?.textContent?.trim()) || null,
            score_taxonomy: parseInt(document.querySelector(`#row-${ingId} td:nth-child(11)`)?.textContent?.trim()) || null,
            score_utility: parseInt(document.querySelector(`#row-${ingId} td:nth-child(12)`)?.textContent?.trim()) || null,
            score_commonness: parseInt(document.querySelector(`#row-${ingId} td:nth-child(13)`)?.textContent?.trim()) || null,
        };

        let html = '';
        for (const item of mapping) {
            const reason = details[item.reasoning] || 'No reasoning recorded.';
            const sc = scoreMap[item.scoreKey];
            const scColour = sc == null ? 'text-gray-400'
                : sc >= 80 ? 'text-green-600 font-bold'
                    : sc >= 60 ? 'text-amber-500 font-bold'
                        : 'text-red-600 font-bold';
            const noteTag = item.noted
                ? '<span class="ml-1 text-xs text-gray-400 italic">(informational ‚Äî not in total)</span>'
                : '';
            html += `<li class="py-3 border-b border-gray-100 last:border-0 flex items-start gap-3">
                <span class="${scColour} w-8 shrink-0 text-sm tabular-nums text-right">${sc ?? '‚Äî'}</span>
                <span><strong class="text-gray-900">${item.label}:</strong>${noteTag} <span class="text-gray-600">${reason}</span></span>
            </li>`;
        }
        document.getElementById('qa-modal-list').innerHTML = html || '<li class="text-gray-400">No reasoning available.</li>';
        document.getElementById('qa-report-modal').classList.remove('hidden');
    }

    function closeQaReport() { document.getElementById('qa-report-modal').classList.add('hidden'); }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeInspector(); closeQaReport(); } });

    // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(msg, type = 'success') {
        const colors = {
            success: 'bg-green-50 text-green-800 ring-green-600/20',
            error: 'bg-red-50 text-red-800 ring-red-600/10',
            warning: 'bg-amber-50 text-amber-800 ring-amber-600/10',
            info: 'bg-blue-50 text-blue-800 ring-blue-600/10',
        };
        const id = `toast-${Date.now()}`;
        document.body.insertAdjacentHTML('beforeend', `
            <div id="${id}" class="fixed top-4 right-4 z-[200] max-w-sm rounded-lg p-4 text-sm font-medium ring-1 ring-inset shadow-md ${colors[type] || colors.success}">
                ${msg}
            </div>`);
        setTimeout(() => {
            const el = document.getElementById(id);
            if (el) { el.style.opacity = '0'; el.style.transition = 'opacity 0.3s'; setTimeout(() => el.remove(), 300); }
        }, 3500);
    }
</script>

<!-- ‚îÄ‚îÄ QA Report Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="qa-report-modal" class="relative z-[70] hidden" aria-modal="true" role="dialog">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-xl border border-gray-200">
                <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-gray-200">
                    <h3 class="text-base font-semibold leading-6 text-gray-900" id="qa-modal-title">QA Report</h3>
                    <button type="button" onclick="closeQaReport()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="px-4 pt-4 pb-2 sm:px-6">
                    <p id="qa-modal-score" class="font-bold mb-4 pb-2 border-b border-gray-200">Total Score: ‚Äî</p>
                    <ul id="qa-modal-list" class="list-none space-y-1 text-sm mb-4"></ul>
                    <p class="text-xs text-gray-400 italic">‚ÑπÔ∏è Global Commonness is informational only and excluded from
                        the total score.</p>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-200">
                    <button type="button" onclick="closeQaReport()"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 sm:mt-0 sm:w-auto">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}