name: Production CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, feature/* ]

env:
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  REGION: europe-west1
  GAR_LOCATION: europe-north2-docker.pkg.dev/${{ secrets.PROJECT_ID }}/app-repo
  SERVICE_NAME: lazy-chef-app
  MIGRATION_JOB_NAME: lazy-chef-db-migration
  WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
  WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: LINT & TEST
  # Runs on every push to feature branches and main.
  # ------------------------------------------------------------------
  test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Linting (Flake8)
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run Unit Tests
        run: |
          # A simple pytest run. Assumes 'tests/' folder exists.
          # If no tests exist yet, we echo a warning instead of failing to allow initial setup.
          if [ -d "tests" ]; then
            pytest tests/
          else
            echo "::warning::No tests/ directory found. Skipping unit tests."
          fi

  # ------------------------------------------------------------------
  # STAGE 2: BUILD, SECURE & DEPLOY
  # Runs ONLY on push to main (Production Deploy)
  # ------------------------------------------------------------------
  deploy:
    name: Build & Deploy to Prod
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker Auth
        run: |
          gcloud auth configure-docker europe-north2-docker.pkg.dev --quiet

      - name: Build and Push Container
        run: |
          IMAGE_TAG=${{ env.GAR_LOCATION }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          # Build with latest tag and specific SHA
          docker build -t $IMAGE_TAG -t ${{ env.GAR_LOCATION }}/${{ env.SERVICE_NAME }}:latest .
          docker push ${{ env.GAR_LOCATION }}/${{ env.SERVICE_NAME }} --all-tags

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.GAR_LOCATION }}/${{ env.SERVICE_NAME }}:${{ github.sha }}'
          format: 'table'
          exit-code: '1' # Fail on severe vulnerabilities
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Update Migration Job
        run: |
          gcloud run jobs update ${{ env.MIGRATION_JOB_NAME }} \
            --image ${{ env.GAR_LOCATION }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --command flask --args db,stamp,head \
            --set-env-vars FLASK_APP=app.py,GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }},DB_BACKEND=cloudsql,INSTANCE_CONNECTION_NAME=thelazychefai-prod:europe-north2:lazy-chef-db-eu,DB_USER=${{ secrets.DB_USER }},DB_PASS=${{ secrets.DB_PASS }},DB_NAME=${{ secrets.DB_NAME }}

      - name: Execute Migration Job
        run: |
          gcloud run jobs execute ${{ env.MIGRATION_JOB_NAME }} --region ${{ env.REGION }} --wait

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          flags: '--allow-unauthenticated'
          env_vars: |
            FLASK_APP=app.py
            GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
            DB_BACKEND=cloudsql
            INSTANCE_CONNECTION_NAME=thelazychefai-prod:europe-north2:lazy-chef-db-eu
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            DB_NAME=${{ secrets.DB_NAME }}
